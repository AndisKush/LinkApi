(()=>{var e={697:(e,o,t)=>{const n=t(147),a=t(38),E=t(40),s=t(487),c=t(419);async function r(){let e,o=n.readFileSync("./config.json"),t=JSON.parse(o),E=[],s=[];const r=[];let O=[],i=[],l=[];r[0]=new Promise(((e,o)=>{a.executeQuerySL(t," delete from eventos e where e.cod_evento not in (select c.cod_evento from cfgeventos c where c.status = 'true') and e.data = current_date ",E,(async function(o,t){e({})}))})),r[1]=new Promise(((e,o)=>{a.executeQuerySL(t," SELECT * FROM CFGEVENTOS C WHERE C.TIPO = 1 AND C.STATUS = 'true' ORDER BY C.COD_EVENTO ",E,(function(o,t){o?console.log(o):(O=t,e(t))}))})),r[2]=new Promise(((e,o)=>{a.executeQuerySL(t," SELECT * FROM CFGEVENTOS C JOIN CFGALL CF ON 1=1 WHERE C.TIPO = 2 AND C.STATUS = 'true' ORDER BY C.DIAS ",E,(function(o,t){o?console.log(o):(i=t,e(t))}))})),r[3]=new Promise(((e,o)=>{a.executeQuerySL(t," SELECT C.*, CAST(C.SQL AS VARCHAR(2000)) AS SQL FROM CFGEVENTOS C WHERE C.TIPO = 3 AND C.STATUS = 'true' ORDER BY C.COD_EVENTO ",E,(function(o,t){o?console.log(o):(l=t,e(t))}))})),r[4]=new Promise(((e,o)=>{a.executeQuerySL(t," execute procedure del_eve_exce ",E,(async function(o,t){e({})}))})),r[5]=new Promise(((o,n)=>{a.executeQuerySL(t," SELECT * FROM CFGALL ",E,(async function(t,n){t?console.log(t):(e=n[0],o(n))}))})),await Promise.all(r);let T=" SELECT DISTINCT 3 as cod_evento  , R.RECEBER as COD_RECEBER  , C.CLIENTE AS ID_CLIENTE  , cast(c.nome as varchar(100) character set ISO8859_1) AS NOME  , cast(CI.RAZAO as varchar(100) character set ISO8859_1) AS RAZAOSOCIAL  , case when POSITION(' ' in C.NOME) = 0 then cast(c.nome as varchar(100) character set ISO8859_1) else cast(SUBSTRING(C.NOME from 1 for POSITION(' ' in C.NOME)) as varchar(100) character set ISO8859_1) end AS PRIMEIRONOME  , (EXTRACT (YEAR FROM CURRENT_DATE) -  EXTRACT ( YEAR FROM CI.NASCIMENTO )) AS IDADE  , R.VALOR  , R.DTVENC AS VENCIMENTO  , R.DTDOC AS DTDOC  , R.NUMDOC  , (select first(1) b.des_linha_digitavel from boleto b join boletoreceber br on br.blt_id = b.blt_id where br.rcb_id = r.receber) as codigodebarrasboleto  , CE.TELEFONE as TELEFONE1  , CE2.TELEFONE as TELEFONE2  FROM CLIENTE C  LEFT JOIN CLI_ENDE CE ON CE.CLIENTE = C.CLIENTE AND CE.TIPO = 'R'  LEFT JOIN CLI_ENDE CE2 ON CE2.CLIENTE = C.CLIENTE AND CE2.TIPO = 'T'  LEFT JOIN CLI_COMP CI ON CI.CLIENTE = C.CLIENTE  left join receber r on r.cliente = c.cliente  LEFT JOIN BOLETORECEBER BR ON BR.RCB_ID = R.RECEBER  LEFT JOIN BOLETO B ON B.BLT_ID = BR.BLT_ID  WHERE  (CE.TIPO = 'R')  AND coalesce(c.flg_inativo,'0')='0'  AND (R.TIPO = 'R'  OR R.TIPO IS NULL)  AND R.DTPGTO IS NULL  AND R.VALOR > 0  AND R.dtvenc = CURRENT_DATE + 1 ";e&&1===e.boletosemitidos&&(T+=" AND B.BLT_BOLETO IS NOT NULL ");for await(const e of O.map((e=>new Promise(((o,n)=>{1===e.cod_evento&&a.executeQueryERP(t," SELECT  DISTINCT 1 as cod_evento  , C.CLIENTE AS ID_CLIENTE  , cast(c.nome as varchar(100) character set ISO8859_1) AS NOME  , cast(CI.RAZAO as varchar(100) character set ISO8859_1) AS RAZAOSOCIAL  , case when POSITION(' ' in C.NOME) = 0 then cast(c.nome as varchar(100) character set ISO8859_1) else cast(SUBSTRING(C.NOME from 1 for POSITION(' ' in C.NOME)) as varchar(100) character set ISO8859_1) end AS PRIMEIRONOME  , (EXTRACT (YEAR FROM CURRENT_DATE) -  EXTRACT ( YEAR FROM CI.NASCIMENTO )) AS IDADE  , 0 as VALOR  , null AS VENCIMENTO  , 0 AS NUMDOC  , '' as codigodebarrasboleto  , CE.TELEFONE as TELEFONE1  , CE2.TELEFONE as TELEFONE2  FROM CLIENTE C  LEFT JOIN CLI_ENDE CE ON CE.CLIENTE = C.CLIENTE AND CE.TIPO = 'R'  LEFT JOIN CLI_ENDE CE2 ON CE2.CLIENTE = C.CLIENTE AND CE2.TIPO = 'T'  LEFT JOIN CLI_COMP CI ON CI.CLIENTE = C.CLIENTE  WHERE  (CE.TIPO = 'R')  AND coalesce(c.flg_inativo,'0')='0'  AND EXTRACT ( MONTH FROM CI.NASCIMENTO ) = EXTRACT (MONTH FROM CURRENT_DATE)  AND EXTRACT ( DAY FROM CI.NASCIMENTO ) = EXTRACT (DAY FROM CURRENT_DATE)  AND C.PESSOA = 'F' ",E,(function(e,t){e?console.log(e):o(t)})),2===e.cod_evento&&a.executeQueryERP(t," SELECT DISTINCT 2 as cod_evento  , R.RECEBER as COD_RECEBER  , C.CLIENTE AS ID_CLIENTE  , cast(c.nome as varchar(100) character set ISO8859_1) AS NOME  , cast(CI.RAZAO as varchar(100) character set ISO8859_1) AS RAZAOSOCIAL  , case when POSITION(' ' in C.NOME) = 0 then cast(c.nome as varchar(100) character set ISO8859_1) else cast(SUBSTRING(C.NOME from 1 for POSITION(' ' in C.NOME)) as varchar(100) character set ISO8859_1) end AS PRIMEIRONOME  , (EXTRACT (YEAR FROM CURRENT_DATE) -  EXTRACT ( YEAR FROM CI.NASCIMENTO )) AS IDADE  , R.VALOR  , (R.VRPAGO+R.MULTA+R.JUROS-R.DESCONTO) AS VALORBAIXA  , R.DTVENC AS VENCIMENTO  , R.DTDOC AS DTDOC  , R.DTPGTO AS DTPGTO  , R.NUMDOC  , (select first(1) b.des_linha_digitavel from boleto b join boletoreceber br on br.blt_id = b.blt_id where br.rcb_id = r.receber) as codigodebarrasboleto  , CE.TELEFONE as TELEFONE1  , CE2.TELEFONE as TELEFONE2  FROM CLIENTE C  LEFT JOIN CLI_ENDE CE ON CE.CLIENTE = C.CLIENTE AND CE.TIPO = 'R'  LEFT JOIN CLI_ENDE CE2 ON CE2.CLIENTE = C.CLIENTE AND CE2.TIPO = 'T'  LEFT JOIN CLI_COMP CI ON CI.CLIENTE = C.CLIENTE  LEFT JOIN RECEBER R ON R.CLIENTE = C.CLIENTE  WHERE  (CE.TIPO = 'R')  and coalesce(c.flg_inativo,'0')='0'  AND R.VALOR > 0  AND R.dtpgto <> R.dtdoc  AND R.dtpgto >= CURRENT_DATE - 3 ",E,(function(e,t){e?console.log(e):o(t)})),3===e.cod_evento&&a.executeQueryERP(t,T,E,(function(e,t){e?console.log(e):o(t)})),4===e.cod_evento&&(E.push(e.cjoperacao),a.executeQueryERP(t," SELECT DISTINCT 4 as cod_evento  , V.VENDA AS COD_VENDA , C.CLIENTE AS ID_CLIENTE  , cast(c.nome as varchar(100) character set ISO8859_1) AS NOME  , cast(CI.RAZAO as varchar(100) character set ISO8859_1) AS RAZAOSOCIAL  , case when POSITION(' ' in C.NOME) = 0 then cast(c.nome as varchar(100) character set ISO8859_1) else cast(SUBSTRING(C.NOME from 1 for POSITION(' ' in C.NOME)) as varchar(100) character set ISO8859_1) end AS PRIMEIRONOME  , (EXTRACT (YEAR FROM CURRENT_DATE) -  EXTRACT ( YEAR FROM CI.NASCIMENTO )) AS IDADE  , V.TOTALDOC AS VALOR  , null AS VENCIMENTO  , V.NRODOC AS NUMDOC  , '' as codigodebarrasboleto  , CE.TELEFONE as TELEFONE1  , CE2.TELEFONE as TELEFONE2  FROM VENDA V  JOIN CLIENTE C ON C.CLIENTE = V.CLIENTE  LEFT JOIN CLI_ENDE CE ON CE.CLIENTE = C.CLIENTE AND CE.TIPO = 'R'  LEFT JOIN CLI_ENDE CE2 ON CE2.CLIENTE = C.CLIENTE AND CE2.TIPO = 'T'  LEFT JOIN CLI_COMP CI ON CI.CLIENTE = C.CLIENTE  WHERE  V.DATDOC = CURRENT_DATE  AND V.OPERACAO IN ( SELECT CJ.OPERACAOD FROM CJOPERACAO CJ WHERE CJ.OPERACAOM = ? ) ",E,(function(e,t){e?console.log(e):o(t)})))})))))s.push(...e);for await(const o of i.map(((n,s)=>new Promise(((n,c)=>{if(0===i[s].diasfixos)if(s<i.length-1){let c=" SELECT DISTINCT "+i[s].cod_evento+" as cod_evento  , 2 as tipo_evento  , R.RECEBER as COD_RECEBER  , C.CLIENTE AS ID_CLIENTE  , cast(c.nome as varchar(100) character set ISO8859_1) AS NOME  , cast(CI.RAZAO as varchar(100) character set ISO8859_1) AS RAZAOSOCIAL  , case when POSITION(' ' in C.NOME) = 0 then cast(c.nome as varchar(100) character set ISO8859_1) else cast(SUBSTRING(C.NOME from 1 for POSITION(' ' in C.NOME)) as varchar(100) character set ISO8859_1) end AS PRIMEIRONOME  , (EXTRACT (YEAR FROM CURRENT_DATE) -  EXTRACT ( YEAR FROM CI.NASCIMENTO )) AS IDADE  , (R.VALOR) AS VALOR  , (R.VALOR+R.MULTA+R.JUROS-R.DESCONTO) AS VALORBAIXA  , R.DTVENC AS VENCIMENTO  , R.DTDOC AS DTDOC  , R.NUMDOC  , (select first(1) b.des_linha_digitavel from boleto b join boletoreceber br on br.blt_id = b.blt_id where br.rcb_id = r.receber) as codigodebarrasboleto  , CE.TELEFONE as TELEFONE1  , CE2.TELEFONE as TELEFONE2  FROM CLIENTE C  LEFT JOIN CLI_ENDE CE ON CE.CLIENTE = C.CLIENTE AND CE.TIPO = 'R'  LEFT JOIN CLI_ENDE CE2 ON CE2.CLIENTE = C.CLIENTE AND CE2.TIPO = 'T'  LEFT JOIN CLI_COMP CI ON CI.CLIENTE = C.CLIENTE  left join receber r on r.cliente = c.cliente  LEFT JOIN BOLETORECEBER BR ON BR.RCB_ID = R.RECEBER  LEFT JOIN BOLETO B ON B.BLT_ID = BR.BLT_ID  WHERE  (CE.TIPO = 'R')  AND coalesce(c.flg_inativo,'0')='0'  AND (R.TIPO = 'R'  OR R.TIPO IS NULL)  AND R.DTPGTO IS NULL  AND R.VALOR > 0  AND R.dtvenc between CURRENT_DATE - "+(i[s+1].dias-1)+" AND CURRENT_DATE - "+i[s].dias;e&&1===e.boletosemitidos&&(c+=" AND B.BLT_BOLETO IS NOT NULL "),a.executeQueryERP(t,c,E,(async function(e,t){e?(o.status(500).json(e),console.log(e)):n(t)}))}else{let c=" SELECT DISTINCT "+i[s].cod_evento+" as cod_evento  , 2 as tipo_evento  , R.RECEBER as COD_RECEBER  , C.CLIENTE AS ID_CLIENTE  , cast(c.nome as varchar(100) character set ISO8859_1) AS NOME  , cast(CI.RAZAO as varchar(100) character set ISO8859_1) AS RAZAOSOCIAL  , case when POSITION(' ' in C.NOME) = 0 then cast(c.nome as varchar(100) character set ISO8859_1) else cast(SUBSTRING(C.NOME from 1 for POSITION(' ' in C.NOME)) as varchar(100) character set ISO8859_1) end AS PRIMEIRONOME  , (EXTRACT (YEAR FROM CURRENT_DATE) -  EXTRACT ( YEAR FROM CI.NASCIMENTO )) AS IDADE  , (R.VALOR) AS VALOR  , (R.VALOR+R.MULTA+R.JUROS-R.DESCONTO) AS VALORBAIXA  , R.DTVENC AS VENCIMENTO  , R.DTDOC AS DTDOC  , R.NUMDOC  , (select first(1) b.des_linha_digitavel from boleto b join boletoreceber br on br.blt_id = b.blt_id where br.rcb_id = r.receber) as codigodebarrasboleto  , CE.TELEFONE as TELEFONE1  , CE2.TELEFONE as TELEFONE2  FROM CLIENTE C  LEFT JOIN CLI_ENDE CE ON CE.CLIENTE = C.CLIENTE AND CE.TIPO = 'R'  LEFT JOIN CLI_ENDE CE2 ON CE2.CLIENTE = C.CLIENTE AND CE2.TIPO='T'  LEFT JOIN CLI_COMP CI ON CI.CLIENTE = C.CLIENTE  left join receber r on r.cliente = c.cliente  LEFT JOIN BOLETORECEBER BR ON BR.RCB_ID = R.RECEBER  LEFT JOIN BOLETO B ON B.BLT_ID = BR.BLT_ID  WHERE  (CE.TIPO = 'R')  AND coalesce(c.flg_inativo,'0')='0'  AND (R.TIPO = 'R'  OR R.TIPO IS NULL)  AND R.DTPGTO IS NULL  AND R.VALOR > 0  AND R.dtvenc between CURRENT_DATE - "+(i[s].maxdiasatraso+i[s].dias)+" AND CURRENT_DATE - "+i[s].dias;e&&1===e.boletosemitidos&&(c+=" AND B.BLT_BOLETO IS NOT NULL "),a.executeQueryERP(t,c,E,(async function(e,t){e?(o.status(500).json(e),console.log(e)):n(t)}))}else{let c=" SELECT DISTINCT "+i[s].cod_evento+" as cod_evento  , 2 as tipo_evento  , R.RECEBER as COD_RECEBER  , C.CLIENTE AS ID_CLIENTE  , cast(c.nome as varchar(100) character set ISO8859_1) AS NOME  , case when POSITION(' ' in C.NOME) = 0 then cast(c.nome as varchar(100) character set ISO8859_1) else cast(SUBSTRING(C.NOME from 1 for POSITION(' ' in C.NOME)) as varchar(100) character set ISO8859_1) end AS PRIMEIRONOME  , cast(CI.RAZAO as varchar(100) character set ISO8859_1) AS RAZAOSOCIAL  , (EXTRACT (YEAR FROM CURRENT_DATE) -  EXTRACT ( YEAR FROM CI.NASCIMENTO )) AS IDADE  , R.VALOR  , (R.VALOR+R.MULTA+R.JUROS-R.DESCONTO) AS VALORBAIXA  , R.DTVENC AS VENCIMENTO  , R.DTDOC AS DTDOC  , R.NUMDOC  , (select first(1) b.des_linha_digitavel from boleto b join boletoreceber br on br.blt_id = b.blt_id where br.rcb_id = r.receber) as codigodebarrasboleto  , CE.TELEFONE as TELEFONE1  , CE2.TELEFONE as TELEFONE2  FROM CLIENTE C  LEFT JOIN CLI_ENDE CE ON CE.CLIENTE = C.CLIENTE AND CE.TIPO = 'R'  LEFT JOIN CLI_ENDE CE2 ON CE2.CLIENTE = C.CLIENTE AND CE2.TIPO='T'  LEFT JOIN CLI_COMP CI ON CI.CLIENTE = C.CLIENTE  left join receber r on r.cliente = c.cliente  LEFT JOIN BOLETORECEBER BR ON BR.RCB_ID = R.RECEBER  LEFT JOIN BOLETO B ON B.BLT_ID = BR.BLT_ID  WHERE  (CE.TIPO = 'R')  AND coalesce(c.flg_inativo,'0')='0'  AND (R.TIPO = 'R'  OR R.TIPO IS NULL)  AND R.DTPGTO IS NULL  AND R.VALOR > 0  AND R.dtvenc = CURRENT_DATE - "+i[s].dias+" ";e&&1===e.boletosemitidos&&(c+=" AND B.BLT_BOLETO IS NOT NULL "),a.executeQueryERP(t,c,E,(async function(e,t){e?(o.status(500).json(e),console.log(e)):n(t)}))}})))))s.push(...o);for await(const e of l.map((e=>new Promise(((o,n)=>{E=[],a.executeQueryERP(t,e.sql,E,(function(e,t){e?console.log(e):o(t)}))})))))s.push(...e);return await new Promise(((e,o)=>{e(async function(e){let o=n.readFileSync("./config.json"),t=JSON.parse(o),E=new Date;E.setHours(0,0,0,0);const s={host:t.hostsl,port:t.porta,database:t.caminhoBancoServerLog,user:t.usuario,password:t.senha,lowercase_keys:!0,role:null,pageSize:16384};c.attach(s,(function(o,t){if(o)return o;t.transaction(c.ISOLATION_READ_COMMITTED,(async function(o,n){if(o)return n.rollback(),o;for(let o=0;o<e.length;o++){let t=e[o],s="UPDATE OR INSERT INTO EVENTOS(COD_EVENTO,TIPO_EVENTO,COD_RECEBER,COD_VENDA,ID_CLIENTE,NOME,TELEFONE1,TELEFONE2,DATA,DTDOC,PRIMEIRONOME,IDADE,VALOR,VALORBAIXA,VENCIMENTO,NUMDOC,CODIGODEBARRASBOLETO, RAZAOSOCIAL, MENSAGEM, DTPGTO) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,(SELECT CAST(CF.MENSAGEM as VARCHAR(1000)) AS MENSAGEM FROM CFGEVENTOS CF WHERE CF.COD_EVENTO = ? ),?) MATCHING (COD_EVENTO, ID_CLIENTE, COD_RECEBER, COD_VENDA, DATA)",c=[parseInt(t.cod_evento),t.tipo_evento,parseInt(t.cod_receber),parseInt(t.cod_venda),parseInt(t.id_cliente),t.nome,t.telefone1,t.telefone2,E,t.dtdoc,t.primeironome,t.idade,t.valor,t.valorbaixa,t.vencimento,t.numdoc,t.codigodebarrasboleto,t.razaosocial,parseInt(t.cod_evento),t.dtpgto];await a.executeQueryTransaction(n,s,c,(function(e,o){e&&n.rollback()}))}return n.commit((function(e){if(e)return n.rollback(),e})),t.detach(),o}))}))}(s))})),s.length}async function O(e,o,t){let E=n.readFileSync("./config.json"),s=JSON.parse(E);const r={host:s.hostsl,port:s.porta,database:s.caminhoBancoServerLog,user:s.usuario,password:s.senha,lowercase_keys:!0,role:null,pageSize:16384};c.attach(r,(function(t,n){if(t)return!!o&&o(t,null);n.transaction(c.ISOLATION_READ_COMMITTED,(async function(t,E){if(t)return E.rollback(),!!o&&o(t,null);for(let o=0;o<e.length;o++){let t=e[o],n="UPDATE OR INSERT INTO EVENTOS(ID,MSGENVIADA, STATUS, LOG) VALUES (?,?,?,?) MATCHING (ID)",s=[parseInt(t.id),t.msgenviada,t.status,t.log];await a.executeQueryTransaction(E,n,s,(function(e,o){e&&E.rollback()}))}return E.commit((function(e){if(e)return E.rollback(),!!o&&o(e,null)})),n.detach(),!o||o(null,!0)}))}))}async function i(e,o){let t=n.readFileSync("./config.json"),c=JSON.parse(t),r=[];a.executeQuerySL(c," SELECT E.*, C.DESCRICAO AS EVENTO, CAST(E.MENSAGEM AS VARCHAR(5000)) AS MENSAGEM, (select c.msgunica from cfgall c) as msgunica FROM EVENTOS E JOIN CFGEVENTOS C ON C.COD_EVENTO = E.COD_EVENTO WHERE E.DATA = CURRENT_DATE AND (E.STATUS = 'Pendente' or E.STATUS = 'Erro') ORDER BY E.VENCIMENTO,E.ID_CLIENTE ",[],(async function(t,n){if(t)console.log(t);else if(e&&(n=e),n.length>0&&0===n[0].msgunica){for(let e=0;e<n.length;e++){let o=n[e];if(o.mensagem=await E.replaceVariables(o.mensagem,o),""!==o.telefone1&&null!==o.telefone1||""!==o.telefone2&&null!==o.telefone2){if("Pendente"===o.status||"Erro"===o.status){const e=600*Math.random()+200;await new Promise((o=>setTimeout(o,e))),await s.sendText(o.telefone1,o.telefone2,o.mensagem,(function(e){if("OK"===e.status){o.status="Enviado",o.log="",o.msgenviada=o.mensagem;let e="UPDATE OR INSERT INTO EVENTOS(ID,MSGENVIADA, STATUS, LOG) VALUES (?,?,?,?) MATCHING (ID)",t=[parseInt(o.id),o.msgenviada,o.status,o.log];a.executeQuerySL(c,e,t,(function(e,o){e&&console.log(e)}))}else o.status="Erro",o.log="Numero Invalido"}))}}else o.status="Erro",o.log="Sem Numero";"Enviado"!==o.status&&r.push(o)}await new Promise(((e,t)=>{e(O(r,o))}))}else{for(let e=0;e<n.length;e++){let o=n[e];if(""!==o.telefone1&&null!==o.telefone1||""!==o.telefone2&&null!==o.telefone2||(o.status="Erro",o.log="Sem NÃºmero"),!o.tipo_evento||2!==o.tipo_evento||"Pendente"!==o.status&&"Erro"!==o.status)"Pendente"!==o.status&&"Erro"!==o.status||(o.mensagem=await E.replaceVariables(o.mensagem,o),""!==o.telefone1&&null!==o.telefone1||""!==o.telefone2&&null!==o.telefone2?await s.sendText(o.telefone1,o.telefone2,o.mensagem,(function(e){if("OK"===e.status){o.status="Enviado",o.log="",o.msgenviada=o.mensagem;let e="UPDATE OR INSERT INTO EVENTOS(ID,MSGENVIADA, STATUS, LOG) VALUES (?,?,?,?) MATCHING (ID)",t=[parseInt(o.id),o.msgenviada,o.status,o.log];a.executeQuerySL(c,e,t,(function(e,o){e&&console.log(e)}))}else o.status="Erro",o.log="Numero Invalido"})):(o.status="Erro",o.log="Sem Numero"));else{let e=[];await n.map((t=>{t.id_cliente!==o.id_cliente||!t.tipo_evento||2!==t.tipo_evento||"Pendente"!==t.status&&"Erro"!==t.status||(""!==t.telefone1&&null!==t.telefone1||""!==t.telefone2&&null!==t.telefone2?(e.push(t),t.status="Enviado",t.log="Mensagem agrupada"):(t.status="Erro",t.log="Sem NÃºmero"))})),o.mensagem=await E.replaceVariables(o.mensagem,o,e);const t=600*Math.random()+200;await new Promise((e=>setTimeout(e,t))),await s.sendText(o.telefone1,o.telefone2,o.mensagem,(function(t){"OK"===t.status?(o.status="Enviado",o.log="Mensagem agrupada",o.msgenviada=o.mensagem,O(e)):e.map((e=>{e.status="Erro",e.log="Numero Invalido"}))}))}"Enviado"!==o.status&&r.push(o)}await new Promise(((e,t)=>{e(O(r,o))}))}}))}e.exports={init:async function(){let e=0,o=[];o[0]=new Promise(((o,t)=>{o(r().then((o=>e=o)))})),await Promise.all(o),o[0]=new Promise((o=>setTimeout(o,1e3+10*e))),await Promise.all(o),o[0]=new Promise((e=>e(i()))),await Promise.all(o)},carregaEventos:r,enviaEventos:i}},38:(e,o,t)=>{const n=t(419);e.exports={executeQueryERP:function(e,o,t,a){const E={host:e.host,hostsl:e.hostsl,port:e.porta,database:e.caminhoBanco,user:e.usuario,password:e.senha,lowercase_keys:!0,role:null,pageSize:16384};n.attach(E,(function(e,n){if(e)return a(e,[]);n.query(o,t,(function(e,o){return n.detach(),e?a(e,[]):(o.map((e=>{for(const o in e){let t=e[o];!0===Buffer.isBuffer(t)&&(e[o]=t.toString("utf-8").trim())}})),a(void 0,o))}))}))},executeQuerySL:async function(e,o,t,a){const E={host:e.hostsl,port:e.porta,database:e.caminhoBancoServerLog,user:e.usuario,password:e.senha,lowercase_keys:!0,role:null,pageSize:16384};n.attach(E,(async function(e,n){if(e)return a(e,[]);n.query(o,t,(async function(e,o){return n.detach(),e?a(e,[]):a(void 0,o)}))}))},executeTransactionSL:async function(e,o,t,a){const E={host:e.hostsl,port:e.porta,database:e.caminhoBancoServerLog,user:e.usuario,password:e.senha,lowercase_keys:!0,role:null,pageSize:16384};n.attach(E,(async function(e,E){if(e)return a(e,[]);await new Promise(((e,s)=>{E.transaction(n.ISOLATION_READ_COMMITED,(function(n,s){for(let n=0;n<t.length;n++)s.query(o,t[n],(function(o,t){o?s.rollback():s.commit((function(o){if(!o)return E.detach(),e(t),a(void 0,!0);s.rollback()}))}))}))}))}))},executeQueryTransaction2:async function(e,o,t){return new Promise(((n,a)=>{e.query(o,t,(function(e,o){return e?(console.log(e),n(!0)):n(o)}))}))},testCon:function(e,o){const t={host:e.host,port:e.porta,database:e.caminhoBanco,user:e.usuario,password:e.senha,lowercase_keys:!0,role:null,pageSize:16384};n.attach(t,(function(t,a){if(t)return o(t,[]);{const t={hostsl:e.hostsl,port:e.porta,database:e.caminhoBancoServerLog,user:e.usuario,password:e.senha,lowercase_keys:!0,role:null,pageSize:16384};n.attach(t,(function(e,t){return e?o(e,[]):o(void 0,void 0)}))}}))},firebird:n,executeQueryTransaction:async function(e,o,t){return new Promise(((n,a)=>{e.query(o,t,(function(e,o){return e?a(e):n(o)}))}))}}},40:e=>{e.exports={replaceVariables:(e,o,t)=>{const n={"{nome}":o.nome&&o.nome.trim(),"{primeironome}":o.primeironome&&o.primeironome.trim(),"{razaosocial}":o.razaosocial&&o.razaosocial.trim(),"{idade}":o.idade,"{data}":o.data&&new Date(o.data).toLocaleDateString("pt-BR"),"{dtdoc}":o.dtdoc&&new Date(o.dtdoc).toLocaleDateString("pt-BR"),"{dtpgto}":o.dtpgto&&new Date(o.dtpgto).toLocaleDateString("pt-BR"),"{valor}":o.valor&&parseFloat(o.valor).toFixed(2),"{valorbaixa}":o.valorbaixa&&parseFloat(o.valorbaixa).toFixed(2),"{vencimento}":o.vencimento&&new Date(o.vencimento).toLocaleDateString("pt-BR"),"{numdoc}":o.numdoc,"{codigodebarrasboleto}":""!==o.codigodebarrasboleto&&null!==o.codigodebarrasboleto?`Para efetuar o pagamento utilize a linha digitavel: ${o.codigodebarrasboleto}`:"","{blocotitulos}":t&&t.map((e=>"*Documento:* "+e.numdoc+"\n*Data da Compra:* "+new Date(e.dtdoc).toLocaleDateString("pt-BR")+"\n*Vencimento:* "+new Date(e.vencimento).toLocaleDateString("pt-BR")+"\n*Valor:* R$ "+e.valor.toFixed(2)+"\n"+(""!==e.codigodebarrasboleto&&null!==e.codigodebarrasboleto?"*Linha DigitÃ¡vel:* "+e.codigodebarrasboleto+"\n\n":"\n"))).join(""),"{blocotitulosvrtotal}":t&&t.map((e=>"*Documento:* "+e.numdoc+"\n*Data da Compra:* "+new Date(e.dtdoc).toLocaleDateString("pt-BR")+"\n*Vencimento:* "+new Date(e.vencimento).toLocaleDateString("pt-BR")+"\n*Valor:* R$ "+e.valorbaixa.toFixed(2)+"\n"+(""!==e.codigodebarrasboleto&&null!==e.codigodebarrasboleto?"*Linha DigitÃ¡vel:* "+e.codigodebarrasboleto+"\n\n":"\n"))).join(""),"{nomeproduto}":o.nomeproduto,"{valororiginal}":o.valororiginal&&parseFloat(o.valororiginal).toFixed(2),"{valorpromocional}":o.valorpromocional&&parseFloat(o.valorpromocional).toFixed(2),"{percentualdesconto}":o.percentualdesconto};return e.replace(/{nome}|{primeironome}|{razaosocial}|{idade}|{data}|{dtdoc}|{dtpgto}|{valor}|{valorbaixa}|{vencimento}|{numdoc}|{codigodebarrasboleto}|{blocotitulos}|{blocotitulosvrtotal}|{nomeproduto}|{valororiginal}|{valorpromocional}|{percentualdesconto}/gi,(e=>n[e]))}}},487:(e,o,t)=>{const n=t(572),a=t(365);let E,s,c,r;async function O(e,o,t){let a=null,E="",s="";if(o&&null!==o&&""!==o&&(E=n(o.toString(),"BR")?.format("E.164")?.replace("+",""),E&&parseFloat(E.substr(2,2))>=22&&13===E.length&&(E=E.substr(0,4)+E.substr(5,8)),E=E&&E.includes("@c.us")?E:`${E}@c.us`),t&&null!==t&&""!==t){s=n(t.toString(),"BR")?.format("E.164")?.replace("+",""),s&&parseFloat(s.substr(2,2))>=22&&13===s.length&&(s=s.substr(0,4)+s.substr(5,8)),s=s&&s.includes("@c.us")?s:`${s}@c.us`;try{await e.checkNumberStatus(s).then((async e=>{e&&e.numberExists&&(a=s)})).catch((e=>console.log(e)))}catch(e){console.log(e)}}return null===a&&(a=E),a}e.exports={initialize:()=>{a.create("webapi",((e,o,t,n)=>{s=e,c=t}),((e,o)=>{r=!!["chatsAvailable","successChat"].includes(e)||e}),{logQR:!1,disableWelcome:!0,autoClose:0}).then((e=>(e=>{E=e})(e))).catch((e=>console.error(e)))},sendText:async function(e,o,t,n){let a=await O(E,e,o);await E.sendText(a,t).then((e=>n(e))).catch((e=>{console.log("nro > "+a+" error > "),console.log(e),n(e)}))},state:async function(e){if(!E)return e(!1);E.getConnectionState().then((o=>{if(["CONNECTED"].includes(o))return e(!0);e(!1)}))},restart:async function(e){console.log("restarting..."),await E.logout().then((o=>e(o))).catch((o=>e(o)))},sendImage:async function(e,o,t,n,a,s){let c=await O(E,e,o);await E.sendImage(c,t,n,a).then((e=>s(e))).catch((e=>{console.log("nro > "+c+" error > "),console.log(e),s(e)}))},sendFile:async function(e,o,t,n,a,s){let c=await O(E,e,o);await E.sendFile(c,t,n,a).then((e=>s(e))).catch((e=>{console.log("nro > "+c+" error > "),console.log(e),s(e)}))},sendButton:async function(e,o,t,n,a,s){let c=await O(E,e,o);await E.sendButtons(c,t,[{buttonText:{displayText:"Text of Button 1"}},{buttonText:{displayText:"Text of Button 2"}}],n).then((e=>{console.log("Result: ",e),s(null,e)})).catch((e=>{console.error("Error when sending: ",e),s(e,null)}))},onMessage:async function(e){E.onMessage((e=>{"linkapi"!==e.body&&"Linkapi"!==e.body||!1!==e.isGroupMsg||E.sendText(e.from,"Bem vindo camponÃªs ðŸ•·").then((e=>{})).catch((e=>{console.error("Error when sending: ",e)}))}))},qrCode:()=>s,nattempts:()=>c,isConnected:()=>r}},618:(e,o,t)=>{const n=t(147),a=t(419),E=t(38);e.exports={updateVersion:async e=>{let o,t=n.readFileSync("./config.json"),s=JSON.parse(t);const c={host:s.hostsl,port:s.porta,database:s.caminhoBancoServerLog,user:s.usuario,password:s.senha,lowercase_keys:!0,role:null,pageSize:16384};await E.executeQuerySL(s,"SELECT C.VERSAO FROM CFGALL C",[],(async function(t,n){if(t)console.log(t);else for(o=n[0].versao;;){if(7===o)return e(null,!0);if(o<1){console.log("Versao 1");let e=[];e[0]="ALTER TABLE CFGALL ADD REMOTO SMALLINT;",e[1]="ALTER TABLE CFGALL ADD CAMINHOREDE VARCHAR(50);",await new Promise(((o,t)=>{a.attach(c,(function(t,n){t?(console.log(t),o(!0)):n.transaction(a.ISOLATION_READ_COMMITTED,(async function(t,a){if(t)a.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Paso > "+o),await E.executeQueryTransaction2(a,e[o],[],(function(e,o){e&&a.rollback()}));a.commit((function(e){e&&a.rollback()})),n.detach(),o(!0)}}))}))})),o=1}if(o<2){console.log("Versao 2");let e=[];e[0]=" CREATE TABLE EVENTOS_EXCECAO(COD_EVENTO INTEGER,ID_CLIENTE INTEGER); ",e[1]=" CREATE PROCEDURE DEL_EVE_EXCE AS BEGIN EXIT; END ",e[2]="\nALTER PROCEDURE DEL_EVE_EXCE AS\ndeclare variable EVENTO integer;\ndeclare variable CLIENTE integer;\nBEGIN\n    FOR SELECT COD_EVENTO, ID_CLIENTE FROM eventos_excecao INTO :EVENTO, :CLIENTE\n    DO\n    BEGIN\n        UPDATE EVENTOS E SET E.status = 'Excecao' where E.cod_evento = :EVENTO and e.id_cliente = :CLIENTE and E.DATA = current_date and E.STATUS <> 'Enviado';\n    END\nEND\n                    ",e[3]="\nCREATE TRIGGER EVENTOS_EXCECAO_BD0 FOR EVENTOS_EXCECAO\nACTIVE BEFORE DELETE POSITION 0 \nAS\nbegin\nupdate eventos e set e.status = 'Pendente' where e.cod_evento = old.cod_evento and e.id_cliente = old.id_cliente and e.data = current_date;\nend\n                     ",e[4]="\nALTER TRIGGER EVENTOS_BI\nas\nbegin\nif (new.id is null) then\n    new.id = gen_id(gen_eventos_id,1);\n\nif (exists (select * from EVENTOS_EXCECAO E WHERE E.cod_evento = new.cod_evento and e.id_cliente = new.id_cliente))\nthen new.status = 'Excecao';\nend\n",e[5]=" ALTER TABLE CFGALL ALTER COLUMN AUTOMATOR POSITION 1; ",e[6]=" ALTER TABLE CFGALL ALTER COLUMN LASTLOGIN POSITION 2; ",e[7]=" ALTER TABLE CFGALL ALTER COLUMN LASTUSER POSITION 3; ",e[8]=" ALTER TABLE CFGALL ALTER COLUMN DIASFIXOS POSITION 4; ",e[9]=" ALTER TABLE CFGALL ALTER COLUMN MAXDIASATRASO POSITION 5; ",e[10]=" ALTER TABLE CFGALL ALTER COLUMN MSGUNICA POSITION 6; ",e[11]=" ALTER TABLE CFGALL ALTER COLUMN REMOTO POSITION 7; ",e[12]=" ALTER TABLE CFGALL ALTER COLUMN CAMINHOREDE POSITION 8; ",e[13]=" GRANT ALL ON EVENTOS_EXCECAO TO SYSDBA WITH GRANT OPTION; ",await new Promise(((o,t)=>{a.attach(c,(function(t,n){t?(console.log(t),o(!0)):n.transaction(a.ISOLATION_READ_COMMITTED,(async function(t,a){if(t)a.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await E.executeQueryTransaction2(a,e[o],[],(function(e,o){e&&a.rollback()}));a.commit((function(e){e&&a.rollback()})),n.detach(),o(!0)}}))}))})),o=2}if(o<3){console.log("Versao 3");let e=[];e[0]=" ALTER TABLE PROMOCAO_LOGS DROP CONSTRAINT PK_PROMOCAO_LOGS; ",e[1]=" DROP TRIGGER PROMOCAO_LOGS_BI; ",e[2]=" ALTER TABLE PROMOCAO_LOGS DROP ID; ",e[3]=" ALTER TABLE CFGALL ALTER COLUMN VERSAO POSITION 9; ",e[4]="ALTER TABLE PROMOCAO_LOGS ALTER COLUMN DATA POSITION 1;",e[5]="ALTER TABLE PROMOCAO_LOGS ALTER COLUMN ID_PROMOCAO POSITION 2;",e[6]="ALTER TABLE PROMOCAO_LOGS ALTER COLUMN ID_CLIENTE POSITION 3;",e[7]=" ALTER TABLE PROMOCAO_LOGS ALTER COLUMN STATUS POSITION 4; ",await new Promise(((o,t)=>{a.attach(c,(function(t,n){t?(console.log(t),o(!0)):n.transaction(a.ISOLATION_READ_COMMITTED,(async function(t,a){if(t)a.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await E.executeQueryTransaction2(a,e[o],[],(function(e,o){e&&a.rollback()}));a.commit((function(e){e&&a.rollback()})),n.detach(),o(!0)}}))}))})),o=3}if(o<4){console.log("Versao 4");let e=[];e[0]="CREATE OR ALTER trigger eventos_bi for eventos\n                    active before insert position 0\n                    as\n                    begin\n                    if (new.id is null) then\n                        new.id = gen_id(gen_eventos_id,1);\n                    \n                    if (exists (select * from EVENTOS_EXCECAO E WHERE E.cod_evento = new.cod_evento and e.id_cliente = new.id_cliente))\n                    then new.status = 'Excecao';\n                    \n                    if (new.cod_evento = 2 and (exists (select * from eventos ev where ev.data >= current_date - 5 and ev.cod_receber = new.cod_receber and ev.status = 'Enviado')))\n                    then new.status = 'Duplicado';\n                    end\n                    ",e[1]=" ALTER TABLE EVENTOS ADD DTPGTO DATE; ",await new Promise(((o,t)=>{a.attach(c,(function(t,n){t?(console.log(t),o(!0)):n.transaction(a.ISOLATION_READ_COMMITTED,(async function(t,a){if(t)a.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await E.executeQueryTransaction2(a,e[o],[],(function(e,o){e&&a.rollback()}));a.commit((function(e){e&&a.rollback()})),n.detach(),o(!0)}}))}))})),o=4}if(o<5){console.log("Versao 5");let e=[];e[0]=" ALTER TABLE CFGALL ADD BOLETOSEMITIDOS SMALLINT; ",await new Promise(((o,t)=>{a.attach(c,(function(t,n){t?(console.log(t),o(!0)):n.transaction(a.ISOLATION_READ_COMMITTED,(async function(t,a){if(t)a.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await E.executeQueryTransaction2(a,e[o],[],(function(e,o){e&&a.rollback()}));a.commit((function(e){e&&a.rollback()})),n.detach(),o(!0)}}))}))})),o=5}if(o<6){console.log("Versao 6");let e=[];e[0]=" update cfgall set boletosemitidos = 0; ",await new Promise(((o,t)=>{a.attach(c,(function(t,n){t?(console.log(t),o(!0)):n.transaction(a.ISOLATION_READ_COMMITTED,(async function(t,a){if(t)a.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await E.executeQueryTransaction2(a,e[o],[],(function(e,o){e&&a.rollback()}));a.commit((function(e){e&&a.rollback()})),n.detach(),o(!0)}}))}))})),o=6}if(o<7){console.log("Versao 7");let e=[];e[0]="\nCREATE OR ALTER trigger eventos_bi for eventos\nactive before insert position 0\nas\nbegin\nif (new.id is null) then\nnew.id = gen_id(gen_eventos_id,1);\n                    \nif (exists (select * from EVENTOS_EXCECAO E WHERE E.cod_evento = new.cod_evento and e.id_cliente = new.id_cliente))\nthen new.status = 'Excecao';\n                    \nif (new.cod_evento = 2 and (exists (select * from eventos ev where ev.data >= current_date - 5 and ev.cod_receber = new.cod_receber and ev.status = 'Enviado' and ev.cod_evento = 2)))\nthen new.status = 'Duplicado';\nend\n",await new Promise(((o,t)=>{a.attach(c,(function(t,n){t?(console.log(t),o(!0)):n.transaction(a.ISOLATION_READ_COMMITTED,(async function(t,a){if(t)a.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await E.executeQueryTransaction2(a,e[o],[],(function(e,o){e&&a.rollback()}));a.commit((function(e){e&&a.rollback()})),n.detach(),o(!0)}}))}))})),o=7}let t=" UPDATE CFGALL SET VERSAO = ? ",n=[];n.push(o),await new Promise((e=>setTimeout(e,1e3))),await E.executeQuerySL(s,t,n,(async function(e,o){e&&console.log(e)}))}}))}}},167:e=>{"use strict";e.exports=require("axios")},582:e=>{"use strict";e.exports=require("cors")},860:e=>{"use strict";e.exports=require("express")},572:e=>{"use strict";e.exports=require("libphonenumber-js")},419:e=>{"use strict";e.exports=require("node-firebird")},365:e=>{"use strict";e.exports=require("venom-bot")},147:e=>{"use strict";e.exports=require("fs")}},o={};function t(n){var a=o[n];if(void 0!==a)return a.exports;var E=o[n]={exports:{}};return e[n](E,E.exports,t),E.exports}(()=>{const e=t(860),o=t(582),n=t(167),a=t(147),E=t(38),s=t(487),c=t(697),r=t(618),O=e();O.use(o()),O.use(e.urlencoded({extended:!1,limit:"50mb"})),O.use(e.json({limit:"50mb"}));try{s.initialize()}catch(e){console.log(e)}try{setInterval((function(){var e=new Date;e.getHours()>=8&&e.getHours()<=20&&async function(e){let o=a.readFileSync("./config.json"),t=JSON.parse(o);let s=[];E.executeQuerySL(t,"SELECT * FROM CFGALL",s,(function(o,a){if(o)console.log(o);else{const o=a[0];if(1!==o.automator)return e(!1);{const a=new Date;if(!o.lastlogin||a.getDay()>o.lastlogin.getDay()||a.getHours()>o.lastlogin.getHours())console.log("validou o usuario"),n.post("http://linkapi-trial.ddns.net:5020/auth/validate",{id:o.lastuser}).then((o=>{if(!o.data)return e(!1);{const o=" UPDATE CFGALL SET LASTLOGIN = ? ";s.push(a),E.executeQuerySL(t,o,s,(function(o,t){if(!o)return e(!0);console.log(o)}))}}));else{const o=" UPDATE CFGALL SET LASTLOGIN = ? ";s.push(a),E.executeQuerySL(t,o,s,(function(o,t){if(!o)return e(!0);console.log(o)}))}}}}))}((function(e){e?(console.log("Rodou o automator"),c.init()):console.log("login invalido ou automator desativado")}))}),3e5)}catch(e){console.log(e)}O.get("/status",((e,o)=>o.status(200).json({qr_code:s.qrCode(),attempts:s.nattempts(),connected:s.isConnected()}))),O.get("/state",((e,o)=>{s.state((function(e){return o.status(200).json(e)}))})),O.get("/initialize",((e,o)=>{try{return s.initialize(),o.status(200).json({})}catch(e){return console.log(e),o.status(200).json({})}})),O.post("/sendText",(async(e,o)=>{const{number1:t,number2:n,message:a}=e.body;await s.sendText(t,n,a,(function(e){return o.status(200).json(e)}))})),O.post("/sendImage",(async(e,o)=>{const{number1:t,number2:n,path:a,name:E,caption:c}=e.body;try{await s.sendImage(t,n,a,E,c,(function(e){return o.status(200).json(e)}))}catch(e){o.status(201).json(e)}})),O.post("/sendFile",(async(e,o)=>{const{number1:t,number2:n,path:a,name:E,caption:c}=e.body;try{await s.sendFile(t,n,a,E,c,(function(e){return o.status(200).json(e)}))}catch(e){console.log(e),o.status(201).json(e)}})),O.post("/sendButton",(async(e,o)=>{const{number1:t,number2:n,title:a,description:E,options:c}=e.body;try{await s.sendButton(t,n,a,E,c,(function(e,t){if(!t)return o.status(200).json(e);o.status(201).json(t)}))}catch(e){console.log(e),o.status(201).json(e)}})),O.post("/onMessage",(async(e,o)=>{try{await s.onMessage((function(e,o){}))}catch(e){console.log(e),o.status(201).json(e)}return o.status(200).json()})),O.get("/versao",((e,o)=>{console.log("7"),r.updateVersion((function(e,t){return e?o.status(500).json(!1):o.status(200).json(!0)}))})),O.get("/cfgall",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t);E.executeQuerySL(n,"SELECT C.*, GEN_ID(gen_cfgeventos_id,0)+1 as proxid FROM CFGALL C",[],(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.post("/cfgall",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t),s=" UPDATE CFGALL ",c=[];e.body.lastuser&&(s+=" SET LASTUSER = ? ",c.push(e.body.lastuser)),0!==e.body.automator&&1!==e.body.automator||(s+=" SET AUTOMATOR = ? ",c.push(e.body.automator)),0!==e.body.diasfixos&&1!==e.body.diasfixos||(s+=" SET DIASFIXOS = ? ",c.push(e.body.diasfixos)),e.body.maxdiasatraso&&(s+=" SET MAXDIASATRASO = ? ",c.push(e.body.maxdiasatraso)),0!==e.body.msgunica&&1!==e.body.msgunica||(s+=" SET MSGUNICA = ? ",c.push(e.body.msgunica)),E.executeQuerySL(n,s,c,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.get("/statusdb",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t);if(JSON.stringify(n)!==JSON.stringify(e.query)){n=e.query;let o=JSON.stringify(n);a.writeFileSync("./config.json",o)}E.testCon(n,(function(e,t){e?(console.log(e),o.status(500).json(e)):o.status(200).json(t)}))})),O.get("/configdb",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t);o.status(200).json(n)})),O.post("/savecfgeventos",(async(e,o)=>{let t,n,s=a.readFileSync("./config.json"),c=JSON.parse(s);null===e.body.cod_evento?(t="INSERT INTO CFGEVENTOS(TIPO, DESCRICAO, DIAS, MENSAGEM, CJOPERACAO, STATUS, SQL) VALUES (?,?,?,?,?,?,?)",n=[parseInt(e.body.tipo),e.body.descricao,parseInt(e.body.dias),e.body.mensagem,parseInt(e.body.cjoperacao),e.body.status,e.body.sql]):(t="UPDATE OR INSERT INTO CFGEVENTOS(COD_EVENTO, TIPO, DESCRICAO, DIAS, MENSAGEM, CJOPERACAO, STATUS, SQL) VALUES (?,?,?,?,?,?,?,?) MATCHING (COD_EVENTO)",n=[parseInt(e.body.cod_evento),parseInt(e.body.tipo),e.body.descricao,parseInt(e.body.dias),e.body.mensagem,parseInt(e.body.cjoperacao),e.body.status,e.body.sql]),E.executeQuerySL(c,t,n,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.get("/eventos",((e,o)=>{let t,n=a.readFileSync("./config.json"),s=JSON.parse(n),c="SELECT E.*, E.ID_CLIENTE AS IDCLIENTE, C.DESCRICAO AS EVENTO, CAST(E.MENSAGEM AS VARCHAR(5000)) AS MENSAGEM, (select c.msgunica from cfgall c) as msgunica FROM EVENTOS E JOIN CFGEVENTOS C ON C.COD_EVENTO = E.COD_EVENTO WHERE E.DATA = ? AND E.STATUS <> 'Excecao' AND E.STATUS <> 'Duplicado ' ",r=new Date;r.setHours(0,0,0,0),t=e.query.data?[e.query.data]:[r],e.query.filtro&&e.query.filtro.length>0&&(c+=" AND E.STATUS IN (",e.query.filtro.map((e=>{"true"===e.status&&(c+=`'${e.nome}', `)})),c+="'')"),c+=" ORDER BY E.STATUS,E.ID_CLIENTE,E.VENCIMENTO ",E.executeQuerySL(s,c,t,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.post("/eventos",(async(e,o)=>{let t,n,s=a.readFileSync("./config.json"),c=JSON.parse(s);t="UPDATE EVENTOS SET NOME = ?, TELEFONE1 = ?, TELEFONE2 = ?, MENSAGEM = ?, DATA = ?, STATUS = ?, LOG = ?, PRIMEIRONOME = ?, IDADE = ?, VALOR = ?, VENCIMENTO = ?, NUMDOC = ?, CODIGODEBARRASBOLETO = ?, RAZAOSOCIAL = ? WHERE ID = ?",n=[e.body.nome,e.body.telefone1,e.body.telefone2,e.body.mensagem,e.body.data,e.body.status,e.body.log,e.body.primeironome,e.body.idade,e.body.valor,e.body.vencimento,e.body.numdoc,e.body.codigodebarrasboleto,e.body.razaosocial,e.body.id],E.executeQuerySL(c,"UPDATE EVENTOS SET NOME = ?, TELEFONE1 = ?, TELEFONE2 = ?, MENSAGEM = ?, DATA = ?, STATUS = ?, LOG = ?, PRIMEIRONOME = ?, IDADE = ?, VALOR = ?, VENCIMENTO = ?, NUMDOC = ?, CODIGODEBARRASBOLETO = ?, RAZAOSOCIAL = ? WHERE ID = ?",n,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.delete("/eventos",(async(e,o)=>{let t,n=a.readFileSync("./config.json"),s=JSON.parse(n);t=" delete from eventos e where e.cod_evento in (select c.cod_evento from cfgeventos c where c.tipo = 2) and e.data = current_date and e.status = 'Pendente' ",E.executeQuerySL(s," delete from eventos e where e.cod_evento in (select c.cod_evento from cfgeventos c where c.tipo = 2) and e.data = current_date and e.status = 'Pendente' ",[],(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.patch("/atualizaeventos",(function(e,o){let t=a.readFileSync("./config.json"),n=JSON.parse(t),s=[e.body.mensagem,e.body.status,e.body.log,parseInt(e.body.id)];E.executeQuerySL(n,"UPDATE EVENTOS SET MENSAGEM = ?, STATUS = ?, LOG = ? WHERE ID = ?",s,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json({result:t})}))})),O.post("/enviaeventos",(function(e,o){lista=[],e.body.length>0?lista=e.body:o.status(204).json("Lista vazia"),c.enviaEventos(lista,(function(e,t){e?o.status(204).json(e):o.status(200).json(t)}))})),O.get("/allcfgeventos",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t),s=[parseInt(e.body.cod_evento),e.body.descricao,e.body.status,e.body.mensagem];E.executeQuerySL(n,"SELECT C.*, CAST(C.MENSAGEM AS VARCHAR(1000)) AS MENSAGEM FROM CFGEVENTOS C ORDER BY C.COD_EVENTO",s,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.get("/cfgeventos1",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t),s=[parseInt(e.body.cod_evento),e.body.descricao,e.body.status,e.body.mensagem];E.executeQuerySL(n,"SELECT C.*, CAST(C.MENSAGEM AS VARCHAR(1000)) AS MENSAGEM FROM CFGEVENTOS C WHERE C.TIPO = 1 ORDER BY C.COD_EVENTO",s,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.get("/cfgeventos2",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t),s=[parseInt(e.body.cod_evento),e.body.descricao,e.body.status,e.body.mensagem];E.executeQuerySL(n,"SELECT C.*, CAST(C.MENSAGEM AS VARCHAR(1000)) AS MENSAGEM FROM CFGEVENTOS C WHERE C.TIPO = 2 ORDER BY C.DIAS",s,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.get("/cfgeventos3",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t),s=[parseInt(e.body.cod_evento),e.body.descricao,e.body.status,e.body.mensagem];E.executeQuerySL(n,"SELECT C.*, CAST(C.MENSAGEM AS VARCHAR(1000)) AS MENSAGEM, CAST(C.SQL AS VARCHAR(2000)) AS SQL FROM CFGEVENTOS C WHERE C.TIPO = 3 ORDER BY C.COD_EVENTO",s,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.delete("/cfgeventos",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t),s=[parseInt(e.query.cod_evento)];E.executeQuerySL(n,"DELETE FROM CFGEVENTOS WHERE COD_EVENTO = ?",s,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.get("/carregaeventos",(async(e,o)=>{c.carregaEventos().then((e=>o.status(200).json(e)))})),O.get("/vendedoreserp",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t);E.executeQueryERP(n," SELECT V.VENDEDOR, cast(v.nome as varchar(100) character set ISO8859_1) AS NOME FROM VENDEDOR V where tipo = 0 and INATIVO = 'N' ORDER BY V.NOME ",[],(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.get("/categoriaserp",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t);E.executeQueryERP(n," select CATEGORIA,cast(nome as varchar(100) character set ISO8859_1) AS NOME from categoria ",[],(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.get("/situacoeserp",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t);E.executeQueryERP(n," SELECT situacao, cast(nome as varchar(100) character set ISO8859_1) AS NOME FROM SITUACAO WHERE TIPO=0 ",[],(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.get("/clienteserp",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t),s=" SELECT DISTINCT C.CLIENTE,cast(c.nome as varchar(100) character set ISO8859_1) AS NOME,CC.RAZAO as RAZAOSOCIAL,CE.TELEFONE as TELEFONE1, (select first(1) ce1.telefone from cli_ende ce1 where ce1.cliente = c.cliente and ce1.tipo = 'T')as telefone2, CID.NOME AS CIDADE, B.NOME AS BAIRRO,(select cat.nome from categoria cat where cat.categoria=C.categoria) as Categoria,C.CONVENIO,C.SITUACAO,C.VENDEDOR  FROM CLIENTE C  LEFT JOIN SITUACAO S ON C.SITUACAO = S.SITUACAO  LEFT JOIN CONVENIO CV ON C.CONVENIO = CV.CONVENIO  LEFT JOIN CLI_ENDE CE ON C.CLIENTE = CE.CLIENTE AND CE.TIPO = 'R'  LEFT JOIN CLI_COMP CC ON CC.CLIENTE = C.CLIENTE  LEFT JOIN BAIRRO B ON CE.BAIRRO = B.BAIRRO  LEFT JOIN CIDADE CID ON CE.CIDADE = CID.CIDADE  WHERE C.CLIENTE IS NOT NULL  AND (c.flg_inativo is null or c.flg_inativo = '0') ",c=[];e.query.vendedor&&(s+=" AND C.VENDEDOR = ? ",c.push(parseFloat(e.query.vendedor))),e.query.categoria&&(s+=" AND C.CATEGORIA = ? ",c.push(e.query.categoria)),e.query.situacao&&(s+=" AND C.SITUACAO = ? ",c.push(e.query.situacao)),E.executeQueryERP(n,s,c,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.get("/eventosexcecao",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t),s=[e.query.cod_evento];E.executeQuerySL(n," SELECT * FROM EVENTOS_EXCECAO WHERE COD_EVENTO = ?",s,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.post("/eventosexcecao",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t),s=[e.body.cod_evento,e.body.id_cliente];E.executeQuerySL(n,"UPDATE OR INSERT INTO EVENTOS_EXCECAO(COD_EVENTO, ID_CLIENTE) VALUES (?,?) MATCHING (COD_EVENTO, ID_CLIENTE)",s,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.delete("/eventosExcecao",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t),s=[e.query.cod_evento,e.query.id_cliente];E.executeQuerySL(n,"DELETE FROM EVENTOS_EXCECAO WHERE COD_EVENTO = ? AND ID_CLIENTE = ?",s,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.get("/promocaoerp",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t);E.executeQueryERP(n,"SELECT T.COD_PROMOCAO, cast(T.NOM_PROMOCAO as varchar(100) character set ISO8859_1) AS NOM_PROMOCAO FROM TAB_PROMOCAO T WHERE T.dat_final >= CURRENT_DATE",[],(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.get("/promocaoapi",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t),s=[parseFloat(e.query.id_promocao)];E.executeQuerySL(n,"SELECT P.*, CAST(MENSAGEM AS VARCHAR(1000)) AS MENSAGEM, CAST(LEGENDA AS VARCHAR(1000)) AS LEGENDA FROM PROMOCAO P WHERE P.ID_PROMOCAO = ?",s,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.get("/promocaologs",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t),s=[e.query.id_promocao];E.executeQuerySL(n," SELECT * FROM PROMOCAO_LOGS P WHERE P.ID_PROMOCAO = ? AND P.DATA = CURRENT_DATE ",s,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.post("/promocaologs",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t),s=[e.body.data,e.body.id_promocao,e.body.id_cliente,e.body.status];E.executeQuerySL(n," UPDATE OR INSERT INTO PROMOCAO_LOGS(DATA,ID_PROMOCAO,ID_CLIENTE,STATUS) VALUES (?,?,?,?) MATCHING (DATA,ID_PROMOCAO,ID_CLIENTE,STATUS) ",s,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.post("/promocaoapi",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t),s=[e.body.id_promocao,e.body.mensagem,e.body.legenda];E.executeQuerySL(n,"UPDATE OR INSERT INTO PROMOCAO(ID_PROMOCAO,MENSAGEM, LEGENDA) VALUES (?,?,?) MATCHING (ID_PROMOCAO)",s,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.get("/produtospromocaoerp",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t),s=[e.query.cod_promocao];E.executeQueryERP(n," SELECT  P.produto as codigoproduto  , P.nome as nomeproduto  , E.vrvend as valororiginal  , T.vlr_vend_promocao as valorpromocional  , T.num_per_promocao as percentualdesconto  , (select c.diretorio_padrao from cfg_geral c) || '\\Imagens\\Produtos\\' || PF.foto as caminhofoto  , PF.foto as nomefoto , PF.base64  FROM TAB_PROMOCAO_ITEM T  JOIN PRODUTO P ON P.produto = t.cod_produto  JOIN ESTOQUE E ON E.deposito = t.cod_deposito and e.produto = p.produto  LEFT JOIN PRODUTOFOTO PF ON PF.produto = P.produto  WHERE T.cod_promocao = ?",s,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.get("/mapa",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t);E.executeQueryERP(n,"SELECT * FROM MAPA ORDER BY MAPA DESC",[],(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),O.get("/mapavendas",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t),s=[e.query.mapa];E.executeQueryERP(n," SELECT V.VENDA,  V.MAPA,  V.CLIENTE,  C.NOME,  V.NRODOC,  V.DATDOC,  VDD.NOME AS VENDEDOR,  V.TOTALDOC,  CE.endereco || ' ' || CE.nro || ' ' || B.NOME || ' ' || CD.NOME || ',' || CD.UF  as ENDERECO  FROM VENDA V  LEFT JOIN CLIENTE C ON V.CLIENTE = C.CLIENTE  LEFT JOIN CLI_ENDE CE ON V.CLIENTE = CE.CLIENTE AND CE.TIPO = 'R'  LEFT JOIN BAIRRO B ON B.BAIRRO = CE.BAIRRO  LEFT JOIN CIDADE CD ON CE.CIDADE = CD.CIDADE  LEFT JOIN VENDEDOR VDD ON VDD.VENDEDOR = V.VENDEDOR  WHERE V.MAPA = ?  AND V.CANCELADO IS NULL  ORDER BY V.NRODOC, V.CLIENTE, V.DATDOC ",s,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))}));let i=a.readFileSync("./config.json"),l=JSON.parse(i);O.listen(l.portApi,(()=>{console.log(">>> WebApi started <<<")}))})()})();