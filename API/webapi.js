(()=>{var e={697:(e,o,t)=>{const n=t(38),a=t(40),s=t(832),E=t(419);async function c(){let e,o=[],t=[],a=[],s="";const c=[];let r=[],i=[],O=[],l=[];c[0]=new Promise(((e,t)=>{n.executeQuerySL(" delete from eventos e where e.cod_evento not in (select c.cod_evento from cfgeventos c where c.status = 'true') and e.data = current_date and e.status <> 'Enviado' ",o,(async function(o,t){e({})}))})),c[1]=new Promise(((e,t)=>{n.executeQuerySL(" SELECT * FROM CFGEVENTOS C WHERE C.TIPO = 1 AND C.STATUS = 'true' ORDER BY C.COD_EVENTO ",o,(function(o,t){o?console.log(o):(r=t,e(t))}))})),c[2]=new Promise(((e,t)=>{n.executeQuerySL(" SELECT * FROM CFGEVENTOS C JOIN CFGALL CF ON 1=1 WHERE C.TIPO = 2 AND C.STATUS = 'true' ORDER BY C.DIAS ",o,(function(o,t){o?console.log(o):(i=t,e(t))}))})),c[3]=new Promise(((e,t)=>{n.executeQuerySL(" SELECT C.*, CAST(C.SQL AS VARCHAR(2000)) AS SQL FROM CFGEVENTOS C WHERE C.TIPO = 3 AND C.STATUS = 'true' ORDER BY C.COD_EVENTO ",o,(function(o,t){o?console.log(o):(O=t,e(t))}))})),c[4]=new Promise(((e,t)=>{n.executeQuerySL(" SELECT C.*, CAST(C.SQL AS VARCHAR(2000)) AS SQL FROM CFGEVENTOS C WHERE C.TIPO = 4 AND C.STATUS = 'true' ORDER BY C.COD_EVENTO ",o,(function(o,t){o?console.log(o):(l=t,e(t))}))})),c[5]=new Promise(((e,t)=>{n.executeQuerySL(" execute procedure del_eve_exce ",o,(async function(o,t){e({})}))})),c[6]=new Promise(((t,a)=>{n.executeQuerySL(" SELECT * FROM CFGALL ",o,(async function(o,n){o?console.log(o):(e=n[0],t(n))}))})),c[7]=new Promise(((e,t)=>{n.executeQuerySL(" SELECT * FROM EVENTOS_EXCECAO_CC ORDER BY COD_EVENTO ",o,(async function(o,t){o?console.log(o):(a=t,e(t))}))})),await Promise.all(c);let T=" \n    SELECT DISTINCT 2 as cod_evento \n     , R.RECEBER as COD_RECEBER \n     , C.CLIENTE AS ID_CLIENTE \n     , cast(c.nome as varchar(100) character set ISO8859_1) AS NOME \n     , cast(CI.RAZAO as varchar(100) character set ISO8859_1) AS RAZAOSOCIAL \n     , case when POSITION(' ' in C.NOME) = 0 then cast(c.nome as varchar(100) character set ISO8859_1) else cast(SUBSTRING(C.NOME from 1 for POSITION(' ' in C.NOME)) as varchar(100) character set ISO8859_1) end AS PRIMEIRONOME \n     , (EXTRACT (YEAR FROM CURRENT_DATE) -  EXTRACT ( YEAR FROM CI.NASCIMENTO )) AS IDADE \n     , R.VALOR \n     , (R.VRPAGO+R.MULTA+R.JUROS-R.DESCONTO) AS VALORBAIXA \n     , R.DTVENC AS VENCIMENTO \n     , R.DTDOC AS DTDOC \n     , R.DTPGTO AS DTPGTO \n     , R.NUMDOC \n     , (select first(1) b.des_linha_digitavel from boleto b join boletoreceber br on br.blt_id = b.blt_id where br.rcb_id = r.receber) as codigodebarrasboleto \n     , CE.TELEFONE as TELEFONE1 \n     , CE2.TELEFONE as TELEFONE2 \n     , cast(r.historico as varchar(100) character set ISO8859_1) AS historico \n     , R.CCUSTO as ID_CC\n     FROM CLIENTE C \n     LEFT JOIN CLI_ENDE CE ON CE.CLIENTE = C.CLIENTE AND CE.TIPO = 'R' \n     LEFT JOIN CLI_ENDE CE2 ON CE2.CLIENTE = C.CLIENTE AND CE2.TIPO = 'T' \n     LEFT JOIN CLI_COMP CI ON CI.CLIENTE = C.CLIENTE \n     LEFT JOIN RECEBER R ON R.CLIENTE = C.CLIENTE \n     WHERE R.DTPGTO IS NOT NULL\n     and (r.tipo = 'R'  or r.tipo IS NULL) \n     and coalesce(c.flg_inativo,'0')='0' \n     AND R.VALOR > 0 \n     AND R.dtpgto <> R.dtdoc \n     AND R.dtpgto >= CURRENT_DATE - 3 \n     AND R.dtpgto <= CURRENT_DATE \n    ";s="",a.map((e=>{2==e.cod_evento&&(s=s+e.id_cc+",")})),""!==s&&(T+=" AND R.CCUSTO NOT IN ("+s+"-999 ) "),e&&1===e.multiempresa&&(T+=" AND R.COD_EMPRESA = "+e.empresa);let C="\n    SELECT DISTINCT 3 as cod_evento \n     , R.RECEBER as COD_RECEBER \n     , C.CLIENTE AS ID_CLIENTE \n     , cast(c.nome as varchar(100) character set ISO8859_1) AS NOME \n     , cast(CI.RAZAO as varchar(100) character set ISO8859_1) AS RAZAOSOCIAL \n     , case when POSITION(' ' in C.NOME) = 0 then cast(c.nome as varchar(100) character set ISO8859_1) else cast(SUBSTRING(C.NOME from 1 for POSITION(' ' in C.NOME)) as varchar(100) character set ISO8859_1) end AS PRIMEIRONOME \n     , (EXTRACT (YEAR FROM CURRENT_DATE) -  EXTRACT ( YEAR FROM CI.NASCIMENTO )) AS IDADE \n     , R.VALOR \n     , R.DTVENC AS VENCIMENTO \n     , R.DTDOC AS DTDOC \n     , R.NUMDOC \n     , (select first(1) b.des_linha_digitavel from boleto b join boletoreceber br on br.blt_id = b.blt_id where br.rcb_id = r.receber) as codigodebarrasboleto \n     , CE.TELEFONE as TELEFONE1 \n     , CE2.TELEFONE as TELEFONE2 \n     , cast(r.historico as varchar(100) character set ISO8859_1) AS historico \n     , R.CCUSTO as ID_CC\n     FROM CLIENTE C \n     LEFT JOIN CLI_ENDE CE ON CE.CLIENTE = C.CLIENTE AND CE.TIPO = 'R' \n     LEFT JOIN CLI_ENDE CE2 ON CE2.CLIENTE = C.CLIENTE AND CE2.TIPO = 'T' \n     LEFT JOIN CLI_COMP CI ON CI.CLIENTE = C.CLIENTE \n     left join receber r on r.cliente = c.cliente \n     LEFT JOIN BOLETORECEBER BR ON BR.RCB_ID = R.RECEBER \n     LEFT JOIN BOLETO B ON B.BLT_ID = BR.BLT_ID \n     WHERE R.DTPGTO IS NULL\n     and (r.tipo = 'R'  or r.tipo IS NULL) \n     AND coalesce(c.flg_inativo,'0')='0' \n     AND (R.TIPO = 'R'  OR R.TIPO IS NULL) \n     AND R.DTPGTO IS NULL \n     AND R.VALOR > 0 \n     AND R.dtvenc = CURRENT_DATE + 1 \n    ";e&&1===e.boletosemitidos&&(C+=" AND B.BLT_BOLETO IS NOT NULL "),s="",a.map((e=>{3==e.cod_evento&&(s=s+e.id_cc+",")})),""!==s&&(C+=" AND R.CCUSTO NOT IN ("+s+"-999 ) "),e&&1===e.multiempresa&&(C+=" AND R.COD_EMPRESA = "+e.empresa);let A="\n    SELECT DISTINCT 4 as cod_evento \n     , V.VENDA AS COD_VENDA \n     , C.CLIENTE AS ID_CLIENTE \n     , cast(c.nome as varchar(100) character set ISO8859_1) AS NOME \n     , cast(CI.RAZAO as varchar(100) character set ISO8859_1) AS RAZAOSOCIAL \n     , case when POSITION(' ' in C.NOME) = 0 then cast(c.nome as varchar(100) character set ISO8859_1) else cast(SUBSTRING(C.NOME from 1 for POSITION(' ' in C.NOME)) as varchar(100) character set ISO8859_1) end AS PRIMEIRONOME \n     , (EXTRACT (YEAR FROM CURRENT_DATE) -  EXTRACT ( YEAR FROM CI.NASCIMENTO )) AS IDADE \n     , V.TOTALDOC AS VALOR \n     , null AS VENCIMENTO \n     , V.NRODOC AS NUMDOC \n     , '' as codigodebarrasboleto \n     , CE.TELEFONE as TELEFONE1 \n     , CE2.TELEFONE as TELEFONE2 \n     FROM VENDA V \n     JOIN CLIENTE C ON C.CLIENTE = V.CLIENTE \n     LEFT JOIN CLI_ENDE CE ON CE.CLIENTE = C.CLIENTE AND CE.TIPO = 'R' \n     LEFT JOIN CLI_ENDE CE2 ON CE2.CLIENTE = C.CLIENTE AND CE2.TIPO = 'T' \n     LEFT JOIN CLI_COMP CI ON CI.CLIENTE = C.CLIENTE \n     WHERE \n     V.DATDOC = CURRENT_DATE \n     AND V.OPERACAO IN ( SELECT CJ.OPERACAOD FROM CJOPERACAO CJ WHERE CJ.OPERACAOM = ? ) \n    ";e&&1===e.multiempresa&&(A+=" AND V.COD_EMPRESA = "+e.empresa);for await(const e of r.map((e=>new Promise(((t,a)=>{1===e.cod_evento&&n.executeQueryERP(" \n    SELECT  DISTINCT 1 as cod_evento \n     , C.CLIENTE AS ID_CLIENTE \n     , cast(c.nome as varchar(100) character set ISO8859_1) AS NOME \n     , cast(CI.RAZAO as varchar(100) character set ISO8859_1) AS RAZAOSOCIAL \n     , case when POSITION(' ' in C.NOME) = 0 then cast(c.nome as varchar(100) character set ISO8859_1) else cast(SUBSTRING(C.NOME from 1 for POSITION(' ' in C.NOME)) as varchar(100) character set ISO8859_1) end AS PRIMEIRONOME \n     , (EXTRACT (YEAR FROM CURRENT_DATE) -  EXTRACT ( YEAR FROM CI.NASCIMENTO )) AS IDADE \n     , 0 as VALOR \n     , null AS VENCIMENTO \n     , 0 AS NUMDOC \n     , '' as codigodebarrasboleto \n     , CE.TELEFONE as TELEFONE1 \n     , CE2.TELEFONE as TELEFONE2 \n     FROM CLIENTE C \n     LEFT JOIN CLI_ENDE CE ON CE.CLIENTE = C.CLIENTE AND CE.TIPO = 'R' \n     LEFT JOIN CLI_ENDE CE2 ON CE2.CLIENTE = C.CLIENTE AND CE2.TIPO = 'T' \n     LEFT JOIN CLI_COMP CI ON CI.CLIENTE = C.CLIENTE \n     WHERE \n     (CE.TIPO = 'R') \n     AND coalesce(c.flg_inativo,'0')='0' \n     AND EXTRACT ( MONTH FROM CI.NASCIMENTO ) = EXTRACT (MONTH FROM CURRENT_DATE) \n     AND EXTRACT ( DAY FROM CI.NASCIMENTO ) = EXTRACT (DAY FROM CURRENT_DATE) \n     AND C.PESSOA = 'F' \n    ",o,(function(e,o){e?console.log(e):t(o)})),2===e.cod_evento&&n.executeQueryERP(T,o,(function(e,o){e?console.log(e):t(o)})),3===e.cod_evento&&n.executeQueryERP(C,o,(function(e,o){e?console.log(e):t(o)})),4===e.cod_evento&&(o.push(e.cjoperacao),n.executeQueryERP(A,o,(function(e,o){e?console.log(e):t(o)})))})))))t.push(...e);for await(const E of i.map(((t,c)=>new Promise(((t,r)=>{if(0===i[c].diasfixos)if(c<i.length-1){let r=`\n                    SELECT DISTINCT ${i[c].cod_evento} as cod_evento \n                     , 2 as tipo_evento \n                     , R.RECEBER as COD_RECEBER \n                     , C.CLIENTE AS ID_CLIENTE \n                     , cast(c.nome as varchar(100) character set ISO8859_1) AS NOME \n                     , cast(CI.RAZAO as varchar(100) character set ISO8859_1) AS RAZAOSOCIAL \n                     , case when POSITION(' ' in C.NOME) = 0 then cast(c.nome as varchar(100) character set ISO8859_1) else cast(SUBSTRING(C.NOME from 1 for POSITION(' ' in C.NOME)) as varchar(100) character set ISO8859_1) end AS PRIMEIRONOME \n                     , (EXTRACT (YEAR FROM CURRENT_DATE) -  EXTRACT ( YEAR FROM CI.NASCIMENTO )) AS IDADE \n                     , (R.VALOR) AS VALOR \n                     , (R.VALOR+R.MULTA+R.JUROS-R.DESCONTO) AS VALORBAIXA \n                     , R.DTVENC AS VENCIMENTO \n                     , R.DTDOC AS DTDOC \n                     , R.NUMDOC \n                     , (select first(1) b.des_linha_digitavel from boleto b join boletoreceber br on br.blt_id = b.blt_id where br.rcb_id = r.receber) as codigodebarrasboleto \n                     , CE.TELEFONE as TELEFONE1 \n                     , CE2.TELEFONE as TELEFONE2 \n                     , cast(r.historico as varchar(100) character set ISO8859_1) AS historico\n                     , R.CCUSTO as ID_CC\n                     FROM CLIENTE C \n                     LEFT JOIN CLI_ENDE CE ON CE.CLIENTE = C.CLIENTE AND CE.TIPO = 'R' \n                     LEFT JOIN CLI_ENDE CE2 ON CE2.CLIENTE = C.CLIENTE AND CE2.TIPO = 'T' \n                     LEFT JOIN CLI_COMP CI ON CI.CLIENTE = C.CLIENTE \n                     left join receber r on r.cliente = c.cliente \n                     LEFT JOIN BOLETORECEBER BR ON BR.RCB_ID = R.RECEBER \n                     LEFT JOIN BOLETO B ON B.BLT_ID = BR.BLT_ID \n                     WHERE R.DTPGTO IS NULL\n                     and (r.tipo = 'R'  or r.tipo IS NULL) \n                     AND coalesce(c.flg_inativo,'0')='0' \n                     AND (R.TIPO = 'R'  OR R.TIPO IS NULL) \n                     AND R.DTPGTO IS NULL \n                     AND R.VALOR > 0 \n                     AND R.dtvenc between CURRENT_DATE - ${i[c+1].dias-1} AND CURRENT_DATE - ${i[c].dias}  \n                    `;e&&1===e.boletosemitidos&&(r+=" AND B.BLT_BOLETO IS NOT NULL "),s="",a.map((e=>{e.cod_evento==i[c].cod_evento&&(s=s+e.id_cc+",")})),""!==s&&(r+=" AND R.CCUSTO NOT IN ("+s+"-999 ) "),e&&1===e.multiempresa&&(r+=" AND R.COD_EMPRESA = "+e.empresa),n.executeQueryERP(r,o,(async function(e,o){e?(E.status(500).json(e),console.log(e)):t(o)}))}else{let r=`\n                    SELECT DISTINCT ${i[c].cod_evento} as cod_evento \n                     , 2 as tipo_evento \n                     , R.RECEBER as COD_RECEBER \n                     , C.CLIENTE AS ID_CLIENTE \n                     , cast(c.nome as varchar(100) character set ISO8859_1) AS NOME \n                     , cast(CI.RAZAO as varchar(100) character set ISO8859_1) AS RAZAOSOCIAL \n                     , case when POSITION(' ' in C.NOME) = 0 then cast(c.nome as varchar(100) character set ISO8859_1) else cast(SUBSTRING(C.NOME from 1 for POSITION(' ' in C.NOME)) as varchar(100) character set ISO8859_1) end AS PRIMEIRONOME \n                     , (EXTRACT (YEAR FROM CURRENT_DATE) -  EXTRACT ( YEAR FROM CI.NASCIMENTO )) AS IDADE \n                     , (R.VALOR) AS VALOR \n                     , (R.VALOR+R.MULTA+R.JUROS-R.DESCONTO) AS VALORBAIXA \n                     , R.DTVENC AS VENCIMENTO \n                     , R.DTDOC AS DTDOC \n                     , R.NUMDOC \n                     , (select first(1) b.des_linha_digitavel from boleto b join boletoreceber br on br.blt_id = b.blt_id where br.rcb_id = r.receber) as codigodebarrasboleto \n                     , CE.TELEFONE as TELEFONE1 \n                     , CE2.TELEFONE as TELEFONE2 \n                     , cast(r.historico as varchar(100) character set ISO8859_1) AS historico\n                     , R.CCUSTO as ID_CC\n                     FROM CLIENTE C \n                     LEFT JOIN CLI_ENDE CE ON CE.CLIENTE = C.CLIENTE AND CE.TIPO = 'R' \n                     LEFT JOIN CLI_ENDE CE2 ON CE2.CLIENTE = C.CLIENTE AND CE2.TIPO='T' \n                     LEFT JOIN CLI_COMP CI ON CI.CLIENTE = C.CLIENTE \n                     left join receber r on r.cliente = c.cliente \n                     LEFT JOIN BOLETORECEBER BR ON BR.RCB_ID = R.RECEBER \n                     LEFT JOIN BOLETO B ON B.BLT_ID = BR.BLT_ID \n                     WHERE R.DTPGTO IS NULL\n                     and (r.tipo = 'R'  or r.tipo IS NULL) \n                     AND coalesce(c.flg_inativo,'0')='0' \n                     AND (R.TIPO = 'R'  OR R.TIPO IS NULL) \n                     AND R.DTPGTO IS NULL \n                     AND R.VALOR > 0 \n                     AND R.dtvenc between CURRENT_DATE - ${i[c].maxdiasatraso+i[c].dias} AND CURRENT_DATE - ${i[c].dias} \n                    `;e&&1===e.boletosemitidos&&(r+=" AND B.BLT_BOLETO IS NOT NULL "),s="",a.map((e=>{e.cod_evento==i[c].cod_evento&&(s=s+e.id_cc+",")})),""!==s&&(r+=" AND R.CCUSTO NOT IN ("+s+"-999 ) "),e&&1===e.multiempresa&&(r+=" AND R.COD_EMPRESA = "+e.empresa),n.executeQueryERP(r,o,(async function(e,o){e?(E.status(500).json(e),console.log(e)):t(o)}))}else{let r=`\n                    SELECT DISTINCT ${i[c].cod_evento} as cod_evento \n                     , 2 as tipo_evento \n                     , R.RECEBER as COD_RECEBER \n                     , C.CLIENTE AS ID_CLIENTE \n                     , cast(c.nome as varchar(100) character set ISO8859_1) AS NOME \n                     , case when POSITION(' ' in C.NOME) = 0 then cast(c.nome as varchar(100) character set ISO8859_1) else cast(SUBSTRING(C.NOME from 1 for POSITION(' ' in C.NOME)) as varchar(100) character set ISO8859_1) end AS PRIMEIRONOME \n                     , cast(CI.RAZAO as varchar(100) character set ISO8859_1) AS RAZAOSOCIAL \n                     , (EXTRACT (YEAR FROM CURRENT_DATE) -  EXTRACT ( YEAR FROM CI.NASCIMENTO )) AS IDADE \n                     , R.VALOR \n                     , (R.VALOR+R.MULTA+R.JUROS-R.DESCONTO) AS VALORBAIXA \n                     , R.DTVENC AS VENCIMENTO \n                     , R.DTDOC AS DTDOC \n                     , R.NUMDOC \n                     , (select first(1) b.des_linha_digitavel from boleto b join boletoreceber br on br.blt_id = b.blt_id where br.rcb_id = r.receber) as codigodebarrasboleto \n                     , CE.TELEFONE as TELEFONE1 \n                     , CE2.TELEFONE as TELEFONE2 \n                     , cast(r.historico as varchar(100) character set ISO8859_1) AS historico\n                     , R.CCUSTO as ID_CC\n                     FROM CLIENTE C \n                     LEFT JOIN CLI_ENDE CE ON CE.CLIENTE = C.CLIENTE AND CE.TIPO = 'R' \n                     LEFT JOIN CLI_ENDE CE2 ON CE2.CLIENTE = C.CLIENTE AND CE2.TIPO='T' \n                     LEFT JOIN CLI_COMP CI ON CI.CLIENTE = C.CLIENTE \n                     left join receber r on r.cliente = c.cliente \n                     LEFT JOIN BOLETORECEBER BR ON BR.RCB_ID = R.RECEBER \n                     LEFT JOIN BOLETO B ON B.BLT_ID = BR.BLT_ID \n                     WHERE R.DTPGTO IS NULL\n                     and (r.tipo = 'R'  or r.tipo IS NULL) \n                     AND coalesce(c.flg_inativo,'0')='0' \n                     AND (R.TIPO = 'R'  OR R.TIPO IS NULL) \n                     AND R.DTPGTO IS NULL \n                     AND R.VALOR > 0 \n                     AND R.dtvenc = CURRENT_DATE - ${i[c].dias} \n                    `;e&&1===e.boletosemitidos&&(r+=" AND B.BLT_BOLETO IS NOT NULL "),s="",a.map((e=>{e.cod_evento==i[c].cod_evento&&(s=s+e.id_cc+",")})),""!==s&&(r+=" AND R.CCUSTO NOT IN ("+s+"-999 ) "),e&&1===e.multiempresa&&(r+=" AND R.COD_EMPRESA = "+e.empresa),n.executeQueryERP(r,o,(async function(e,o){e?(E.status(500).json(e),console.log(e)):t(o)}))}})))))t.push(...E);for await(const e of O.map((e=>new Promise(((t,a)=>{o=[],n.executeQueryERP(e.sql,o,(function(e,o){e?console.log(e):t(o)}))})))))t.push(...e);for await(const e of l.map((e=>new Promise(((t,a)=>{o=[],n.executeQueryERP(e.sql,o,(function(e,o){e?console.log(e):(o.map((e=>{e.tipo_evento=4})),t(o))}))})))))t.push(...e);return await new Promise(((e,o)=>{e(async function(e){let o=(new Date).toLocaleString("pt-BR");E.attach(n.dbOptionsSL,(function(t,a){if(t)return t;a.transaction(E.ISOLATION_READ_COMMITTED,(async function(t,s){if(t)return s.rollback(),t;for(let t=0;t<e.length;t++){let a=e[t],E="UPDATE OR INSERT INTO EVENTOS(COD_EVENTO,TIPO_EVENTO,COD_RECEBER,COD_VENDA,ID_CLIENTE,NOME,TELEFONE1,TELEFONE2,DATA,DTDOC,PRIMEIRONOME,IDADE,VALOR,VALORBAIXA,VENCIMENTO,NUMDOC,CODIGODEBARRASBOLETO, RAZAOSOCIAL, MENSAGEM, DTPGTO, HISTORICO, OUTROS1, OUTROS2, ID_CC) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,(SELECT CAST(CF.MENSAGEM as VARCHAR(5000)) AS MENSAGEM FROM CFGEVENTOS CF WHERE CF.COD_EVENTO = ? ),?,?,?,?,?) MATCHING (COD_EVENTO, ID_CLIENTE, COD_RECEBER, COD_VENDA, DATA)",c=[parseInt(a.cod_evento),a.tipo_evento,parseInt(a.cod_receber),parseInt(a.cod_venda),parseInt(a.id_cliente),a.nome,a.telefone1,a.telefone2,o,a.dtdoc,a.primeironome,a.idade,a.valor,a.valorbaixa,a.vencimento,a.numdoc,a.codigodebarrasboleto,a.razaosocial,parseInt(a.cod_evento),a.dtpgto,a.historico,a.outros1,a.outros2,a.id_cc];await n.executeQueryTransaction(s,E,c,(function(e,o){e&&s.rollback()}))}return s.commit((function(e){if(e)return s.rollback(),e})),a.detach(),t}))}))}(t))})),t.length}async function r(e,o,t){E.attach(n.dbOptionsSL,(function(t,a){if(t)return!!o&&o(t,null);a.transaction(E.ISOLATION_READ_COMMITTED,(async function(t,s){if(t)return s.rollback(),!!o&&o(t,null);for(let o=0;o<e.length;o++){let t=e[o],a="UPDATE OR INSERT INTO EVENTOS(ID,MSGENVIADA, STATUS, LOG) VALUES (?,?,?,?) MATCHING (ID)",E=[parseInt(t.id),t.msgenviada,t.status,t.log];await n.executeQueryTransaction(s,a,E,(function(e,o){e&&s.rollback()}))}return s.commit((function(e){if(e)return s.rollback(),!!o&&o(e,null)})),a.detach(),!o||o(null,!0)}))}))}async function i(e,o){let t=[];n.executeQuerySL("SELECT FIRST 150 E.*, \n        C.DESCRICAO AS EVENTO, \n        CAST(E.MENSAGEM AS VARCHAR(5000)) AS MENSAGEM, \n        (select c.msgunica from cfgall c) as msgunica \n    FROM EVENTOS E \n    JOIN CFGEVENTOS C ON C.COD_EVENTO = E.COD_EVENTO \n    WHERE E.DATA = CURRENT_DATE \n    AND (E.STATUS = 'Pendente' or E.STATUS = 'Erro') \n    AND (C.MANUAL = 0 or C.MANUAL is null)\n    ORDER BY E.VENCIMENTO,E.ID_CLIENTE",[],(async function(n,E){if(n)console.log(n);else if(e&&(E=e),E.length>0&&0===E[0].msgunica){for(let e=0;e<E.length;e++){let o=E[e];if(o.mensagem=await a.replaceVariables(o.mensagem,o),""!==o.telefone1&&null!==o.telefone1||""!==o.telefone2&&null!==o.telefone2){if("Pendente"===o.status||"Erro"===o.status){const e=600*Math.random()+300;await new Promise((o=>setTimeout(o,e))),await s.sendText(o.telefone1,o.telefone2,o.mensagem,(async function(e){"OK"===e.status?(o.status="Enviado",o.log="",o.msgenviada=o.mensagem,await r([o])):(console.log(e),o.status="Erro",o.log="Numero Invalido")}))}}else o.status="Erro",o.log="Sem Numero";"Enviado"!==o.status&&t.push(o)}await new Promise(((e,n)=>{e(r(t,o))}))}else{for(let e=0;e<E.length;e++){let o=E[e];if(""!==o.telefone1&&null!==o.telefone1||""!==o.telefone2&&null!==o.telefone2)if(!o.tipo_evento||2!==o.tipo_evento||"Pendente"!==o.status&&"Erro"!==o.status)"Pendente"!==o.status&&"Erro"!==o.status||(o.mensagem=await a.replaceVariables(o.mensagem,o),""!==o.telefone1&&null!==o.telefone1||""!==o.telefone2&&null!==o.telefone2?await s.sendText(o.telefone1,o.telefone2,o.mensagem,(async function(e){if("OK"===e.status)return o.status="Enviado",o.log="",o.msgenviada=o.mensagem,await r([o]),!0;console.log(e),o.status="Erro",o.log="Numero Invalido"})):(o.status="Erro",o.log="Sem Numero"));else{let e=[],t=0,n=0;await E.map((a=>{a.id_cliente!==o.id_cliente||!a.tipo_evento||2!==a.tipo_evento||"Pendente"!==a.status&&"Erro"!==a.status||(""!==a.telefone1&&null!==a.telefone1||""!==a.telefone2&&null!==a.telefone2?(t+=a.valor,n+=a.valorbaixa,e.push(a),a.status="Enviado",a.log="Mensagem agrupada"):(a.status="Erro",a.log="Sem Número"))})),o.mensagem=await a.replaceVariables(o.mensagem,o,e,t,n);const c=600*Math.random()+300;await new Promise((e=>setTimeout(e,c))),await s.sendText(o.telefone1,o.telefone2,o.mensagem,(async function(t){if("OK"===t.status)return o.status="Enviado",o.log="Mensagem agrupada",o.msgenviada=o.mensagem,await r(e),!0;e.map((e=>{console.log(t),e.status="Erro",e.log="Numero Invalido"}))}))}else o.status="Erro",o.log="Sem Número";"Enviado"!==o.status&&t.push(o)}await new Promise(((e,n)=>{e(r(t,o))}))}}))}e.exports={init:async function(){let e=0,o=[];o[0]=new Promise(((o,t)=>{o(c().then((o=>e=o)))})),await Promise.all(o),o[0]=new Promise((o=>setTimeout(o,1e3+10*e))),await Promise.all(o),o[0]=new Promise((e=>e(i()))),await Promise.all(o)},carregaEventos:c,enviaEventos:i,enviaPromocao:async function(e,o){let t=(new Date).toLocaleString("pt-BR"),c=[];const r=e.clients,i=e.products,O=e.mensagensPromo,l=e.promoSelecionada;for(let e=0;e<r.length;e++){let o=r[e];if(o.mensagem=await a.replaceVariables(O.mensagem,o),""!==o.telefone1&&null!==o.telefone1||""!==o.telefone2&&null!==o.telefone2){if("Enviado"!==o.status){const e=800*Math.random()+500;await new Promise((o=>setTimeout(o,e))),await s.sendText(o.telefone1,o.telefone2,o.mensagem,(async function(e){if("OK"===e.status){for(let e=0;e<i.length;e++){let t=i[e];if(t.base64){t.legenda=await a.replaceVariables(O.legenda,{...t,...o});const e=600*Math.random()+300;await new Promise((o=>setTimeout(o,e))),await s.sendImage64(o.telefone1,o.telefone2,t.base64,"",t.legenda,(async function(e){"OK"===e.status?(o.status="Enviado",o.log=""):(o.status="Erro",o.log="Numero Invalido")}))}}let e=" UPDATE OR INSERT INTO PROMOCAO_LOGS(DATA,ID_PROMOCAO,ID_CLIENTE,STATUS) VALUES (?,?,?,?) MATCHING (DATA,ID_PROMOCAO,ID_CLIENTE,STATUS) ",E=[t,l.cod_promocao,o.cliente,o.status];n.executeQuerySL(e,E,(function(e,o){e&&console.log(e)}))}else console.log(e),o.status="Erro",o.log="Numero Invalido"}));const E=600*Math.random()+9e3;await new Promise((e=>setTimeout(e,E)))}}else o.status="Erro",o.log="Sem Numero";o.cod_promocao=l.cod_promocao,"Enviado"!==o.status&&c.push(o)}await new Promise(((e,t)=>{e(async function(e,o){let t=(new Date).toLocaleString("pt-BR");E.attach(n.dbOptionsSL,(function(a,s){if(a)return!!o&&o(a,null);s.transaction(E.ISOLATION_READ_COMMITTED,(async function(a,E){if(a)return E.rollback(),!!o&&o(a,null);for(let o=0;o<e.length;o++){let a=e[o],s=" UPDATE OR INSERT INTO PROMOCAO_LOGS(DATA,ID_PROMOCAO,ID_CLIENTE,STATUS) VALUES (?,?,?,?) MATCHING (DATA,ID_PROMOCAO,ID_CLIENTE,STATUS) ",c=[t,a.cod_promocao,a.cliente,a.status];await n.executeQueryTransaction(E,s,c,(function(e,o){e&&E.rollback()}))}return E.commit((function(e){if(e)return E.rollback(),!!o&&o(e,null)})),s.detach(),!o||o(null,!0)}))}))}(c,o))}))},initPromocao:async()=>{let e;try{e=await new Promise((async(e,o)=>{await n.executeQuerySL("SELECT P.*, CAST(MENSAGEM AS VARCHAR(5000)) AS MENSAGEM, CAST(LEGENDA AS VARCHAR(1000)) AS LEGENDA FROM PROMOCAO P WHERE P.STATUS = 2",[],(function(t,n){t?o(t):e(n)}))}))}catch(e){return void console.log(e)}if(e&&!(e?.length<=0)){mensagensEnviadas=0;do{const o=e[Math.round(Math.random()*(e.length-1))],t=`SELECT * \n                        FROM PROMOCAO_LOGS P \n                        WHERE P.ID_PROMOCAO = ${o.id_promocao} \n                        AND (P.DATA = CURRENT_DATE OR P.DATA IS NULL) \n                        AND P.STATUS IN ('Pendente','Enviado')`;let E;try{E=await new Promise((async(e,o)=>{await n.executeQuerySL(t,[],(function(t,n){t?o(t):e(n)}))}))}catch(e){return void console.log(e)}const c=E.filter((e=>"Pendente"===e.status.trim())),r=E.filter((e=>"Enviado"===e.status.trim()));if(0===c.length){const e=`UPDATE PROMOCAO SET STATUS = 3 WHERE ID_PROMOCAO = ${o.id_promocao} `;try{await new Promise((async(o,t)=>{await n.executeQuerySL(e,[],(function(e,n){e?t(e):o(n)}))}))}catch(e){return void console.log(e)}return}if(c?.length>0){const e=`SELECT * FROM PROMOCAO_PRODUTOS P WHERE P.ID_PROMOCAO = ${o.id_promocao}`;let t;try{t=await new Promise((async(o,t)=>{await n.executeQuerySL(e,[],(function(e,n){e?t(e):o(n)}))}))}catch(e){return void console.log(e)}await new Promise((e=>setTimeout(e,2e3)));const E=o.mensagem?1+t.length:t.length;if(!(E*r.length+E<=o.maximodiario))break;{const e=c[0];let E=!1;if(""!==e.telefone1&&null!==e.telefone1||""!==e.telefone2&&null!==e.telefone2){if(o.mensagem)try{const t=await a.replaceVariables(o.mensagem,e);await s.sendText(e.telefone1,e.telefone2,t,(async function(e){if("OK"===e.status){E=!0,mensagensEnviadas+=1;const e=800*Math.random()+500;await new Promise((o=>setTimeout(o,e)))}}))}catch(e){console.log(e)}}else E=!1;for(let n=0;n<t.length;n++){const c=t[n];try{const t=await a.replaceVariables(o.legenda,{...e,...c});if(await s.sendImage64(e.telefone1,e.telefone2,c.base64,"",t,(async function(e){"OK"===e.status&&(E=!0,mensagensEnviadas+=1)})),E){const e=600*Math.random()+300;await new Promise((o=>setTimeout(o,e)))}}catch(e){console.log(e)}}const r=`UPDATE PROMOCAO_LOGS SET \n                                STATUS = '${E?"Enviado":"Erro"}',\n                                DATA = CURRENT_DATE\n                                WHERE ID_PROMOCAO = ${o.id_promocao}\n                                AND ID_CLIENTE = ${e.id_cliente}\n                                `;try{await new Promise((async(e,o)=>{await n.executeQuerySL(r,[],(function(t,n){t?o(t):e(n)}))}))}catch(e){return void console.log(e)}}}}while(mensagensEnviadas<50)}},testaEnviaPromocao:async e=>{let o=!1;if(""===e.telefone||null===e.telefone)o=!1;else{if(e.mensagem)try{const t=await a.replaceVariables(e.mensagem,{nome:"Cliente Teste"});await s.sendText(e.telefone,null,t,(async function(e){if("OK"===e.status){o=!0;const e=800*Math.random()+500;await new Promise((o=>setTimeout(o,e)))}}))}catch(e){console.log(e)}for(let t=0;t<e.produtos.length;t++){const n=e.produtos[t];try{const t=await a.replaceVariables(e.legenda,{nome:"Cliente Teste",...n});if(await s.sendImage64(e.telefone,null,n.base64,"",t,(async function(e){"OK"===e.status&&(o=!0)})),o){const e=600*Math.random()+300;await new Promise((o=>setTimeout(o,e)))}}catch(e){console.log(e)}}}return!!o}}},38:(e,o,t)=>{const n=t(419);t(523).setDefaultResultOrder("ipv4first");let a=t(147).readFileSync("./config.json"),s=JSON.parse(a);const E={user:s.usuario,password:s.senha,port:s.porta,host:s.host,database:s.caminho,lowercase_keys:!0,role:null,pageSize:16384,blobAsText:!0},c={user:s.usuariosl,password:s.senhasl,port:s.portasl,host:s.hostsl,database:s.caminhosl,lowercase_keys:!0,role:null,pageSize:16384,connectTimeout:5e3,max_transactions:100,blobAsText:!0},r=(e,o,t)=>new Promise(((n,a)=>{o.query(e,t,((e,o)=>{e?a(e):n(o)}))})),i=e=>new Promise(((o,t)=>{e.startTransaction(n.ISOLATION_READ_COMMITTED,((e,n)=>{e?t(e):o(n)}))})),O=e=>new Promise(((o,t)=>{e.commit((e=>{e?t(e):o()}))})),l=e=>new Promise(((o,t)=>{e.rollback((()=>{o()}))}));e.exports={executeQueryERP:function(e,o,t){n.attach(E,(function(n,a){if(n)return t(n,[]);a.query(e,o,(function(e,o){return a.detach(),e?t(e,[]):(o.map((e=>{for(const o in e){let t=e[o];!0===Buffer.isBuffer(t)&&(e[o]=t.toString("utf-8").trim())}})),t(void 0,o))}))}))},executeQuerySL:async function(e,o,t){n.attach(c,(async function(n,a){if(n)return t(n,[]);a.query(e,o,(async function(e,o){return a.detach(),e?t(e,[]):t(void 0,o)}))}))},executeTransactionSL:async function(e,o,t){n.attach(c,(async function(a,s){if(a)return t(a,[]);await new Promise(((a,E)=>{s.transaction(n.ISOLATION_READ_COMMITED,(function(n,E){for(let n=0;n<o.length;n++)E.query(e,o[n],(function(e,o){e?E.rollback():E.commit((function(e){if(!e)return s.detach(),a(o),t(void 0,!0);E.rollback()}))}))}))}))}))},executeQueryTransaction2:async function(e,o,t){return new Promise(((n,a)=>{e.query(o,t,(function(e,o){return e?(console.log(e),n(!0)):n(o)}))}))},testCon:function(e){n.attach(E,(function(o,t){if(o)return e(o,[]);n.attach(c,(function(o,t){return o?e(o,[]):e(void 0,void 0)}))}))},executeQuerySL2:function(e,o){return new Promise(((t,a)=>{n.attach(c,(async function(s,E){s?a(s):E.startTransaction(n.ISOLATION_READ_COMMITTED,(async function(n,s){if(n)return E.detach(),void a(n);s.query(e,o,(function(e,o){e?s.rollback((function(o){E.detach(),a(o||e)})):s.commit((function(e){E.detach(),e?a(e):t(o)}))}))}))}))}))},executeBatchInsertSL:async(e,o)=>{const t=await new Promise(((e,o)=>{n.attach(c,((t,n)=>{t?o(t):e(n)}))}));try{for(const n of o){const o=await i(t);try{for(const t of n)await r(e,o,t);await O(o)}catch(e){throw console.error("Erro durante a transação:",e),console.log("Rollback da transação"),await l(o),e}}}finally{t.detach()}},firebird:n,executeQueryTransaction:async function(e,o,t){return new Promise(((n,a)=>{e.query(o,t,(function(e,o){return e?a(e):n(o)}))}))},dbOptionsERP:E,dbOptionsSL:c}},40:e=>{e.exports={replaceVariables:(e,o,t,n,a)=>{const s={"{nome}":o.nome&&o.nome.trim(),"{primeironome}":o.primeironome&&o.primeironome.trim(),"{razaosocial}":o.razaosocial&&o.razaosocial.trim(),"{idade}":o.idade,"{data}":o.data&&new Date(o.data).toLocaleDateString("pt-BR"),"{dtdoc}":o.dtdoc&&new Date(o.dtdoc).toLocaleDateString("pt-BR"),"{dtpgto}":o.dtpgto&&new Date(o.dtpgto).toLocaleDateString("pt-BR"),"{valor}":o.valor&&parseFloat(o.valor).toFixed(2),"{valorbaixa}":o.valorbaixa&&parseFloat(o.valorbaixa).toFixed(2),"{vencimento}":o.vencimento&&new Date(o.vencimento).toLocaleDateString("pt-BR"),"{numdoc}":o.numdoc,"{historico}":""!==o.historico&&null!==o.historico?"*Historico:* "+o.historico:"","{codigodebarrasboleto}":""!==o.codigodebarrasboleto&&null!==o.codigodebarrasboleto?`Para efetuar o pagamento utilize a linha digitavel: ${o.codigodebarrasboleto}`:"","{valortotalbloco}":n&&parseFloat(n).toFixed(2),"{valortotalbaixabloco}":a&&parseFloat(a).toFixed(2),"{blocotitulos}":t&&t.map((e=>"*Documento:* "+e.numdoc+"\n*Data da Compra:* "+new Date(e.dtdoc).toLocaleDateString("pt-BR")+"\n*Vencimento:* "+new Date(e.vencimento).toLocaleDateString("pt-BR")+"\n*Valor:* R$ "+e.valor.toFixed(2)+"\n"+(""!==e.codigodebarrasboleto&&null!==e.codigodebarrasboleto?"*Linha Digitável:* "+e.codigodebarrasboleto+"\n\n":"\n"))).join(""),"{blocotituloshistorico}":t&&t.map((e=>"*Documento:* "+e.numdoc+"\n*Data da Compra:* "+new Date(e.dtdoc).toLocaleDateString("pt-BR")+"\n*Vencimento:* "+new Date(e.vencimento).toLocaleDateString("pt-BR")+"\n*Valor:* R$ "+e.valor.toFixed(2)+"\n"+(""!==e.historico&&null!==e.historico?"*Historico:* "+e.historico+"\n":"")+(""!==e.codigodebarrasboleto&&null!==e.codigodebarrasboleto?"*Linha Digitável:* "+e.codigodebarrasboleto+"\n\n":"\n"))).join(""),"{blocotitulosvrtotal}":t&&t.map((e=>"*Documento:* "+e.numdoc+"\n*Data da Compra:* "+new Date(e.dtdoc).toLocaleDateString("pt-BR")+"\n*Vencimento:* "+new Date(e.vencimento).toLocaleDateString("pt-BR")+"\n*Valor:* R$ "+e.valorbaixa.toFixed(2)+"\n"+(""!==e.codigodebarrasboleto&&null!==e.codigodebarrasboleto?"*Linha Digitável:* "+e.codigodebarrasboleto+"\n\n":"\n"))).join(""),"{blocotitulosvrtotalhistorico}":t&&t.map((e=>"*Documento:* "+e.numdoc+"\n*Data da Compra:* "+new Date(e.dtdoc).toLocaleDateString("pt-BR")+"\n*Vencimento:* "+new Date(e.vencimento).toLocaleDateString("pt-BR")+"\n*Valor:* R$ "+e.valorbaixa.toFixed(2)+"\n"+(""!==e.historico&&null!==e.historico?"*Historico:* "+e.historico+"\n":"")+(""!==e.codigodebarrasboleto&&null!==e.codigodebarrasboleto?"*Linha Digitável:* "+e.codigodebarrasboleto+"\n\n":"\n"))).join(""),"{numerosdocumentos}":t&&" / "+t.map((e=>e.numdoc+" / ")).join(""),"{outros1}":o.outros1&&o.outros1.trim(),"{outros2}":o.outros2&&o.outros2.trim(),"{nomeproduto}":o.nomeproduto,"{valororiginal}":o.valororiginal&&parseFloat(o.valororiginal).toFixed(2),"{valorpromocional}":o.valorpromocional&&parseFloat(o.valorpromocional).toFixed(2),"{percentualdesconto}":o.percentualdesconto};return e.replace(/{nome}|{primeironome}|{razaosocial}|{idade}|{data}|{dtdoc}|{dtpgto}|{valor}|{valorbaixa}|{vencimento}|{numdoc}|{codigodebarrasboleto}|{blocotitulos}|{blocotitulosvrtotal}|{blocotituloshistorico}|{blocotitulosvrtotalhistorico}|{nomeproduto}|{valororiginal}|{valorpromocional}|{percentualdesconto}|{historico}|{valortotalbloco}|{valortotalbaixabloco}|{numerosdocumentos}|{outros1}|{outros2}/gi,(e=>s[e]))}}},832:(e,o,t)=>{const n=t(121),{Client:a,LocalAuth:s,MessageMedia:E,List:c,Buttons:r}=t(55),i=t(572),O=new a({authStrategy:new s,userDataDir:"./.wwebjs_auth/session"});let l,T="Conectando";async function C(e){let o=null,t="";return e&&null!==e&&""!==e&&(t=i(e.toString(),"BR")?.format("E.164")?.replace("+",""),t&&parseFloat(t.substr(2,2))>=28&&13===t.length&&(t=t.substr(0,4)+t.substr(5,8)),t&&(t=t&&t.includes("@c.us")?t:`${t}@c.us`)),null===o&&(o=t),o}async function A(e,o,t){let n=null;if(!(e&&null!==e&&""!==e||o&&null!==o&&""!==o))return t({error:"ERROR SEM NUMERO"});if(e?.length<15&&(e=null),o?.length<15&&(o=null),o&&null!==o&&""!==o)await O.isRegisteredUser(o).then((async t=>{if(t)n=o;else{if(!e||null===e||""===e)return!1;await O.isRegisteredUser(e).then((o=>{if(!o)return!1;n=e}))}}));else{if(!e)return!1;await O.isRegisteredUser(e).then((o=>{if(!o)return!1;n=e}))}return n}O.on("qr",(e=>{n.toDataURL(e,(function(e,o){console.log("Aguardando Leitura do QRCode"),l=o}))})),O.on("ready",(()=>{console.log("Client is ready!"),T=!0})),O.on("disconnected",(()=>{console.log("Aparelho Desconectado"),T="Conectando",O.initialize()})),e.exports={initialize:()=>{O.initialize()},sendText:async function(e,o,t,n){let a=await C(e),s=await C(o),E=null;return E=await A(a,s,n),E?""===t?n({status:"OK"}):void await O.sendMessage(E,t).then((()=>n({status:"OK"}))).catch((e=>{console.log(e)})):n({error:"ERROR NUMERO INVALIDO"})},sendImage:async function(e,o,t,n,a,s){let c=await C(e),r=await C(o),i=null;if(i=await A(c,r,s),!i)return s({error:"ERROR NUMERO INVALIDO"});{const e=E.fromFilePath(t);O.sendMessage(i,e,{caption:a}).then((()=>{s({status:"OK"})})).catch((e=>{console.log(e)}))}},sendImage64:async function(e,o,t,n,a,s){let c=await C(e),r=await C(o),i=null;if(i=await A(c,r,s),new Buffer.from(t).toString("base64"),!i)return s({error:"ERROR NUMERO INVALIDO"});{const e=await new E("image/jpg",t);await O.sendMessage(i,e,{caption:a}).then((()=>s({status:"OK"}))).catch((e=>{console.log(e)}))}},sendFile:async function(e,o,t,n,a,s){let c=await C(e),r=await C(o),i=null;if(i=await A(c,r,s),!i)return s({error:"ERROR NUMERO INVALIDO"});{const e=E.fromFilePath(t);O.sendMessage(i,e,{caption:a}).then((()=>{s({status:"OK"})})).catch((e=>{console.log(e)}))}},sendButton:async function(e,o,t,n,a,s,E){let c=await C(e),i=await C(o),l=null;if(l=await A(c,i,E),!l)return E({error:"ERROR NUMERO INVALIDO"});{let e=new r("Button body",[{body:"bt1"},{body:"bt2"},{body:"bt3"}],"title","footer");O.sendMessage(l,e).then((()=>{E({status:"OK"})})).catch((e=>{console.log(e)}))}},onMessage:async function(e){O.on("message",(o=>{"!oi"==o.body&&(o.reply("Bem vindo a LinkApi"),e({status:"OK"}))}))},qrCode:()=>l,isConnected:()=>T}},618:(e,o,t)=>{const n=t(419),a=t(38);e.exports={updateVersion:async e=>{let o;await a.executeQuerySL("SELECT C.VERSAO FROM CFGALL C",[],(async function(t,s){if(t)console.log(t);else for(o=s[0].versao;;){if(16===o)return e(null,!0);if(o<1){console.log("Versao 1");let e=[];e[0]="ALTER TABLE CFGALL ADD REMOTO SMALLINT;",e[1]="ALTER TABLE CFGALL ADD CAMINHOREDE VARCHAR(50);",await new Promise(((o,t)=>{n.attach(a.dbOptionsSL,(function(t,s){t?(console.log(t),o(!0)):s.transaction(n.ISOLATION_READ_COMMITTED,(async function(t,n){if(t)n.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Paso > "+o),await a.executeQueryTransaction2(n,e[o],[],(function(e,o){e&&n.rollback()}));n.commit((function(e){e&&n.rollback()})),s.detach(),o(!0)}}))}))})),o=1}if(o<2){console.log("Versao 2");let e=[];e[0]=" CREATE TABLE EVENTOS_EXCECAO(COD_EVENTO INTEGER,ID_CLIENTE INTEGER); ",e[1]=" CREATE PROCEDURE DEL_EVE_EXCE AS BEGIN EXIT; END ",e[2]="\nALTER PROCEDURE DEL_EVE_EXCE AS\ndeclare variable EVENTO integer;\ndeclare variable CLIENTE integer;\nBEGIN\n    FOR SELECT COD_EVENTO, ID_CLIENTE FROM eventos_excecao INTO :EVENTO, :CLIENTE\n    DO\n    BEGIN\n        UPDATE EVENTOS E SET E.status = 'Excecao' where E.cod_evento = :EVENTO and e.id_cliente = :CLIENTE and E.DATA = current_date and E.STATUS <> 'Enviado';\n    END\nEND\n                    ",e[3]="\nCREATE TRIGGER EVENTOS_EXCECAO_BD0 FOR EVENTOS_EXCECAO\nACTIVE BEFORE DELETE POSITION 0 \nAS\nbegin\nupdate eventos e set e.status = 'Pendente' where e.cod_evento = old.cod_evento and e.id_cliente = old.id_cliente and e.data = current_date;\nend\n                     ",e[4]="\nALTER TRIGGER EVENTOS_BI\nas\nbegin\nif (new.id is null) then\n    new.id = gen_id(gen_eventos_id,1);\n\nif (exists (select * from EVENTOS_EXCECAO E WHERE E.cod_evento = new.cod_evento and e.id_cliente = new.id_cliente))\nthen new.status = 'Excecao';\nend\n",e[5]=" ALTER TABLE CFGALL ALTER COLUMN AUTOMATOR POSITION 1; ",e[6]=" ALTER TABLE CFGALL ALTER COLUMN LASTLOGIN POSITION 2; ",e[7]=" ALTER TABLE CFGALL ALTER COLUMN LASTUSER POSITION 3; ",e[8]=" ALTER TABLE CFGALL ALTER COLUMN DIASFIXOS POSITION 4; ",e[9]=" ALTER TABLE CFGALL ALTER COLUMN MAXDIASATRASO POSITION 5; ",e[10]=" ALTER TABLE CFGALL ALTER COLUMN MSGUNICA POSITION 6; ",e[11]=" ALTER TABLE CFGALL ALTER COLUMN REMOTO POSITION 7; ",e[12]=" ALTER TABLE CFGALL ALTER COLUMN CAMINHOREDE POSITION 8; ",e[13]=" GRANT ALL ON EVENTOS_EXCECAO TO SYSDBA WITH GRANT OPTION; ",await new Promise(((o,t)=>{n.attach(a.dbOptionsSL,(function(t,s){t?(console.log(t),o(!0)):s.transaction(n.ISOLATION_READ_COMMITTED,(async function(t,n){if(t)n.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await a.executeQueryTransaction2(n,e[o],[],(function(e,o){e&&n.rollback()}));n.commit((function(e){e&&n.rollback()})),s.detach(),o(!0)}}))}))})),o=2}if(o<3){console.log("Versao 3");let e=[];e[0]=" ALTER TABLE PROMOCAO_LOGS DROP CONSTRAINT PK_PROMOCAO_LOGS; ",e[1]=" DROP TRIGGER PROMOCAO_LOGS_BI; ",e[2]=" ALTER TABLE PROMOCAO_LOGS DROP ID; ",e[3]=" ALTER TABLE CFGALL ALTER COLUMN VERSAO POSITION 9; ",e[4]="ALTER TABLE PROMOCAO_LOGS ALTER COLUMN DATA POSITION 1;",e[5]="ALTER TABLE PROMOCAO_LOGS ALTER COLUMN ID_PROMOCAO POSITION 2;",e[6]="ALTER TABLE PROMOCAO_LOGS ALTER COLUMN ID_CLIENTE POSITION 3;",e[7]=" ALTER TABLE PROMOCAO_LOGS ALTER COLUMN STATUS POSITION 4; ",await new Promise(((o,t)=>{n.attach(a.dbOptionsSL,(function(t,s){t?(console.log(t),o(!0)):s.transaction(n.ISOLATION_READ_COMMITTED,(async function(t,n){if(t)n.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await a.executeQueryTransaction2(n,e[o],[],(function(e,o){e&&n.rollback()}));n.commit((function(e){e&&n.rollback()})),s.detach(),o(!0)}}))}))})),o=3}if(o<4){console.log("Versao 4");let e=[];e[0]="CREATE OR ALTER trigger eventos_bi for eventos\n                    active before insert position 0\n                    as\n                    begin\n                    if (new.id is null) then\n                        new.id = gen_id(gen_eventos_id,1);\n                    \n                    if (exists (select * from EVENTOS_EXCECAO E WHERE E.cod_evento = new.cod_evento and e.id_cliente = new.id_cliente))\n                    then new.status = 'Excecao';\n                    \n                    if (new.cod_evento = 2 and (exists (select * from eventos ev where ev.data >= current_date - 5 and ev.cod_receber = new.cod_receber and ev.status = 'Enviado')))\n                    then new.status = 'Duplicado';\n                    end\n                    ",e[1]=" ALTER TABLE EVENTOS ADD DTPGTO DATE; ",await new Promise(((o,t)=>{n.attach(a.dbOptionsSL,(function(t,s){t?(console.log(t),o(!0)):s.transaction(n.ISOLATION_READ_COMMITTED,(async function(t,n){if(t)n.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await a.executeQueryTransaction2(n,e[o],[],(function(e,o){e&&n.rollback()}));n.commit((function(e){e&&n.rollback()})),s.detach(),o(!0)}}))}))})),o=4}if(o<5){console.log("Versao 5");let e=[];e[0]=" ALTER TABLE CFGALL ADD BOLETOSEMITIDOS SMALLINT; ",await new Promise(((o,t)=>{n.attach(a.dbOptionsSL,(function(t,s){t?(console.log(t),o(!0)):s.transaction(n.ISOLATION_READ_COMMITTED,(async function(t,n){if(t)n.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await a.executeQueryTransaction2(n,e[o],[],(function(e,o){e&&n.rollback()}));n.commit((function(e){e&&n.rollback()})),s.detach(),o(!0)}}))}))})),o=5}if(o<6){console.log("Versao 6");let e=[];e[0]=" update cfgall set boletosemitidos = 0; ",await new Promise(((o,t)=>{n.attach(a.dbOptionsSL,(function(t,s){t?(console.log(t),o(!0)):s.transaction(n.ISOLATION_READ_COMMITTED,(async function(t,n){if(t)n.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await a.executeQueryTransaction2(n,e[o],[],(function(e,o){e&&n.rollback()}));n.commit((function(e){e&&n.rollback()})),s.detach(),o(!0)}}))}))})),o=6}if(o<7){console.log("Versao 7");let e=[];e[0]="\nCREATE OR ALTER trigger eventos_bi for eventos\nactive before insert position 0\nas\nbegin\nif (new.id is null) then\nnew.id = gen_id(gen_eventos_id,1);\n                    \nif (exists (select * from EVENTOS_EXCECAO E WHERE E.cod_evento = new.cod_evento and e.id_cliente = new.id_cliente))\nthen new.status = 'Excecao';\n                    \nif (new.cod_evento = 2 and (exists (select * from eventos ev where ev.data >= current_date - 5 and ev.cod_receber = new.cod_receber and ev.status = 'Enviado' and ev.cod_evento = 2)))\nthen new.status = 'Duplicado';\nend\n",await new Promise(((o,t)=>{n.attach(a.dbOptionsSL,(function(t,s){t?(console.log(t),o(!0)):s.transaction(n.ISOLATION_READ_COMMITTED,(async function(t,n){if(t)n.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await a.executeQueryTransaction2(n,e[o],[],(function(e,o){e&&n.rollback()}));n.commit((function(e){e&&n.rollback()})),s.detach(),o(!0)}}))}))})),o=7}if(o<8){console.log("Versao 8");let e=[];e[0]=" ALTER TABLE CFGEVENTOS ADD MANUAL SMALLINT; ",await new Promise(((o,t)=>{n.attach(a.dbOptionsSL,(function(t,s){t?(console.log(t),o(!0)):s.transaction(n.ISOLATION_READ_COMMITTED,(async function(t,n){if(t)n.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await a.executeQueryTransaction2(n,e[o],[],(function(e,o){e&&n.rollback()}));n.commit((function(e){e&&n.rollback()})),s.detach(),o(!0)}}))}))})),o=8}if(o<9){console.log("Versao 9");let e=[];e[0]=" ALTER TABLE EVENTOS ADD HISTORICO VARCHAR(255); ",await new Promise(((o,t)=>{n.attach(a.dbOptionsSL,(function(t,s){t?(console.log(t),o(!0)):s.transaction(n.ISOLATION_READ_COMMITTED,(async function(t,n){if(t)n.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await a.executeQueryTransaction2(n,e[o],[],(function(e,o){e&&n.rollback()}));n.commit((function(e){e&&n.rollback()})),s.detach(),o(!0)}}))}))})),o=9}if(o<10){console.log("Versao 10");let e=[];e[0]="CREATE OR ALTER trigger eventos_bi for eventos\n                    active before insert position 0\n                    as\n                    begin\n                    if (new.id is null) then\n                    new.id = gen_id(gen_eventos_id,1);\n                                        \n                    if (exists (select * from EVENTOS_EXCECAO E WHERE E.cod_evento = new.cod_evento and e.id_cliente = new.id_cliente))\n                    then new.status = 'Excecao';\n                                        \n                    if (new.cod_evento = 2 and (exists (select * from eventos ev where ev.data >= current_date - 5 and ev.cod_receber = new.cod_receber and ev.status = 'Enviado' and ev.cod_evento = 2)))\n                    then new.status = 'Duplicado';\n                    \n                    if (new.tipo_evento = 4 and (exists (SELECT * FROM eventos ev where extract (month from ev.data) = extract (month from current_date) and ev.cod_evento = new.cod_evento and ev.id_cliente = new.id_cliente and ev.status = 'Enviado')))\n                    then new.status = 'Duplicado';\n                    end",await new Promise(((o,t)=>{n.attach(a.dbOptionsSL,(function(t,s){t?(console.log(t),o(!0)):s.transaction(n.ISOLATION_READ_COMMITTED,(async function(t,n){if(t)n.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await a.executeQueryTransaction2(n,e[o],[],(function(e,o){e&&n.rollback()}));n.commit((function(e){e&&n.rollback()})),s.detach(),o(!0)}}))}))})),o=10}if(o<11){console.log("Versao 11");let e=[];e[0]="CREATE OR ALTER trigger eventos_bi for eventos\nactive before insert position 0\nas\nbegin\n    if (new.id is null) then\n        new.id = gen_id(gen_eventos_id,1);\n                        \n    if (exists (select * from EVENTOS_EXCECAO E WHERE E.cod_evento = new.cod_evento and e.id_cliente = new.id_cliente))\n        then new.status = 'Excecao';\n                        \n    if (new.cod_evento = 2 and (exists (select * from eventos ev where ev.data >= current_date - 5 and ev.cod_receber = new.cod_receber and ev.status = 'Enviado' and ev.cod_evento = 2)))\n        then new.status = 'Duplicado';\n    \n    if (new.tipo_evento = 4 and (exists (SELECT * FROM eventos ev where extract (month from ev.data) = extract (month from current_date) and ev.cod_evento = new.cod_evento and ev.id_cliente = new.id_cliente and ev.status = 'Enviado' and ev.cod_receber = new.cod_receber and ev.cod_venda = new.cod_venda)))\n        then new.status = 'Duplicado';\n\n    if (new.tipo_evento = 5 and (exists (SELECT * FROM eventos ev where ev.cod_evento = new.cod_evento and ev.id_cliente = new.id_cliente and ev.status = 'Enviado' and ev.cod_receber = new.cod_receber and ev.cod_venda = new.cod_venda)))\n        then new.status = 'Duplicado';\nend",await new Promise(((o,t)=>{n.attach(a.dbOptionsSL,(function(t,s){t?(console.log(t),o(!0)):s.transaction(n.ISOLATION_READ_COMMITTED,(async function(t,n){if(t)n.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await a.executeQueryTransaction2(n,e[o],[],(function(e,o){e&&n.rollback()}));n.commit((function(e){e&&n.rollback()})),s.detach(),o(!0)}}))}))})),o=11}if(o<12){console.log("Versao 12");let e=[];e[0]="ALTER TABLE EVENTOS ADD OUTROS1 VARCHAR(200);",e[1]="ALTER TABLE EVENTOS ADD OUTROS2 VARCHAR(200);",await new Promise(((o,t)=>{n.attach(a.dbOptionsSL,(function(t,s){t?(console.log(t),o(!0)):s.transaction(n.ISOLATION_READ_COMMITTED,(async function(t,n){if(t)n.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await a.executeQueryTransaction2(n,e[o],[],(function(e,o){e&&n.rollback()}));n.commit((function(e){e&&n.rollback()})),s.detach(),o(!0)}}))}))})),o=12}if(o<13){console.log("Versao 13");let e=[];e[0]="CREATE TABLE EVENTOS_EXCECAO_CC (COD_EVENTO INTEGER,ID_CC INTEGER);",e[1]="ALTER TABLE EVENTOS ADD ID_CC INTEGER;",e[2]="\ncreate or alter procedure DEL_EVE_EXCE\nas\ndeclare variable EVENTO integer;\ndeclare variable CLIENTE integer;\ndeclare variable CC integer;\nBEGIN\n    FOR SELECT COD_EVENTO, ID_CLIENTE FROM eventos_excecao INTO :EVENTO, :CLIENTE\n    DO\n    BEGIN\n        UPDATE EVENTOS E SET E.status = 'Excecao' where E.cod_evento = :EVENTO and e.id_cliente = :CLIENTE and E.DATA = current_date and E.STATUS <> 'Enviado';\n    END\n    FOR SELECT COD_EVENTO, ID_CC FROM eventos_excecao_cc INTO :EVENTO, :CC\n    DO\n    BEGIN\n        UPDATE EVENTOS E SET E.status = 'Excecao' where E.cod_evento = :EVENTO and e.id_CC = :CC and E.DATA = current_date and E.STATUS <> 'Enviado';\n    END\nEND\n",e[3]="\nCREATE trigger eventos_excecao_cc_bd0 for eventos_excecao_cc\nactive before delete position 0\nAS\nbegin\n  update eventos e set e.status = 'Pendente' where e.cod_evento = old.cod_evento and e.id_cc = old.id_cc and e.data = current_date;\nend\n",await new Promise(((o,t)=>{n.attach(a.dbOptionsSL,(function(t,s){t?(console.log(t),o(!0)):s.transaction(n.ISOLATION_READ_COMMITTED,(async function(t,n){if(t)n.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await a.executeQueryTransaction2(n,e[o],[],(function(e,o){e&&n.rollback()}));n.commit((function(e){e&&n.rollback()})),s.detach(),o(!0)}}))}))})),o=13}if(o<14){console.log("Versao 14");let e=[];e[0]="ALTER TABLE CFGALL ADD MULTIEMPRESA SMALLINT;",e[1]="ALTER TABLE CFGALL ADD EMPRESA SMALLINT;",await new Promise(((o,t)=>{n.attach(a.dbOptionsSL,(function(t,s){t?(console.log(t),o(!0)):s.transaction(n.ISOLATION_READ_COMMITTED,(async function(t,n){if(t)n.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await a.executeQueryTransaction2(n,e[o],[],(function(e,o){e&&n.rollback()}));n.commit((function(e){e&&n.rollback()})),s.detach(),o(!0)}}))}))})),o=14}if(o<15){console.log("Versao 15");let e=[];e[0]="UPDATE CFGALL SET MULTIEMPRESA = 0;",e[1]="UPDATE CFGALL SET EMPRESA = 0;",await new Promise(((o,t)=>{n.attach(a.dbOptionsSL,(function(t,s){t?(console.log(t),o(!0)):s.transaction(n.ISOLATION_READ_COMMITTED,(async function(t,n){if(t)n.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await a.executeQueryTransaction2(n,e[o],[],(function(e,o){e&&n.rollback()}));n.commit((function(e){e&&n.rollback()})),s.detach(),o(!0)}}))}))})),o=15}if(o<16){console.log("Versao 16");let e=[];e[0]="ALTER TABLE PROMOCAO ADD MAXIMODIARIO SMALLINT;",e[1]="ALTER TABLE PROMOCAO ADD STATUS SMALLINT;",e[2]="ALTER TABLE PROMOCAO_LOGS ADD NOME VARCHAR(60);",e[3]="ALTER TABLE PROMOCAO_LOGS ADD TELEFONE1 VARCHAR(30);",e[4]="ALTER TABLE PROMOCAO_LOGS ADD TELEFONE2 VARCHAR(30);",e[5]="CREATE TABLE PROMOCAO_PRODUTOS (\n                        ID_PROMOCAO INTEGER NOT NULL,\n                        ID_PRODUTO VARCHAR(14) NOT NULL,\n                        NOMEPRODUTO VARCHAR(120),\n                        VALORORIGINAL NUMERIC(18,4),\n                        VALORPROMOCIONAL NUMERIC(18,4),\n                        PERCENTUALDESCONTO NUMERIC(18,4),\n                        BASE64 BLOB SUB_TYPE 1 SEGMENT SIZE 4096 CHARACTER SET ISO8859_1);",await new Promise(((o,t)=>{n.attach(a.dbOptionsSL,(function(t,s){t?(console.log(t),o(!0)):s.transaction(n.ISOLATION_READ_COMMITTED,(async function(t,n){if(t)n.rollback(),o(!0);else{for(let o=0;o<e.length;o++)console.log("Passo > "+o),await a.executeQueryTransaction2(n,e[o],[],(function(e,o){e&&n.rollback()}));n.commit((function(e){e&&n.rollback()})),s.detach(),o(!0)}}))}))})),o=16}let t=" UPDATE CFGALL SET VERSAO = ? ",s=[];s.push(o),await new Promise((e=>setTimeout(e,1e3))),await a.executeQuerySL(t,s,(async function(e,o){e&&console.log(e)}))}}))}}},167:e=>{"use strict";e.exports=require("axios")},582:e=>{"use strict";e.exports=require("cors")},860:e=>{"use strict";e.exports=require("express")},572:e=>{"use strict";e.exports=require("libphonenumber-js")},419:e=>{"use strict";e.exports=require("node-firebird")},121:e=>{"use strict";e.exports=require("qrcode")},55:e=>{"use strict";e.exports=require("whatsapp-web.js")},523:e=>{"use strict";e.exports=require("dns")},147:e=>{"use strict";e.exports=require("fs")}},o={};function t(n){var a=o[n];if(void 0!==a)return a.exports;var s=o[n]={exports:{}};return e[n](s,s.exports,t),s.exports}(()=>{const e=t(860),o=t(582),n=t(167),a=t(147),s=t(38),E=t(832),c=t(697),r=t(618),i=e();i.use(o()),i.use(e.urlencoded({extended:!1,limit:"50mb"})),i.use(e.json({limit:"50mb"}));try{E.initialize()}catch(e){console.log(e)}try{setInterval((function(){var e=new Date;e.getHours()>=8&&e.getHours()<=20&&async function(e){let o=[];const t=e=>{const t=new Date;o.push(t),s.executeQuerySL(" UPDATE CFGALL SET LASTLOGIN = ? ",o,(function(o,t){if(!o)return e(!0);console.log(o)}))};s.executeQuerySL("SELECT * FROM CFGALL",o,(function(o,a){if(o)console.log("Erro ao buscar CFGALL no banco"),console.log(o);else{const o=a[0];if(1!==o.automator)return console.log("Envio automático desativado"),e(!1);{const a=new Date;if(!(!o.lastlogin||a.getDay()>o.lastlogin.getDay()||a.getHours()>o.lastlogin.getHours()))return t(e);n.post("http://linkapi.ddns.net:5020/auth/validate",{id:o.lastuser}).then((o=>o.data?t(e):(console.log("Login Invalido"),e(!1)))).catch((a=>{if(console.log("Erro server 1 AUTH: "+a.code+" "+a.errno),-4039!==a.errno)return e(!1);n.post("http://linkapi.freeddns.org:5020/auth/validate",{id:o.lastuser}).then((o=>o.data?t(e):(console.log("Login Invalido"),e(!1)))).catch((o=>(console.log("Erro server 2 AUTH: "+o.code),e(!1))))}))}}}))}((function(e){e&&c.init()}))}),9e5)}catch(e){console.log(e)}try{setInterval((function(){var e=new Date;e.getHours()>=8&&e.getHours()<=20&&c.initPromocao()}),305123)}catch(e){console.log(e)}i.post("/globalversion",((e,o)=>{!async function(e,o){7>=e?o(!0):(n.get("http://127.0.0.1:5025/update"),o(!1))}(e.body.globalVersion,(function(e){return o.status(200).json(e)}))})),i.get("/teste",((e,o)=>{})),i.get("/status",((e,o)=>o.status(200).json({qr_code:E.qrCode(),connected:E.isConnected()}))),i.get("/state",((e,o)=>{E.state((function(e){return o.status(200).json(e)}))})),i.get("/initialize",((e,o)=>{try{return E.initialize(),o.status(200).json({})}catch(e){return console.log(e),o.status(200).json({})}})),i.post("/sendText",(async(e,o)=>{const{number1:t,number2:n,message:a}=e.body;await E.sendText(t,n,a,(function(e){return o.status(200).json(e)}))})),i.post("/sendImage",(async(e,o)=>{const{number1:t,number2:n,path:a,name:s,caption:c}=e.body;try{await E.sendImage(t,n,a,s,c,(function(e){return o.status(200).json(e)}))}catch(e){o.status(201).json(e)}})),i.post("/sendFile",(async(e,o)=>{const{number1:t,number2:n,path:a,name:s,caption:c}=e.body;try{await E.sendFile(t,n,a,s,c,(function(e){return o.status(200).json(e)}))}catch(e){console.log(e),o.status(201).json(e)}})),i.post("/sendButton",(async(e,o)=>{const{number1:t,number2:n,title:a,description:s,options:c,footer:r}=e.body;try{await E.sendButton(t,n,a,s,c,r,(function(e){return o.status(200).json(e)}))}catch(e){console.log(e),o.status(201).json(e)}})),i.post("/onMessage",(async(e,o)=>{try{await E.onMessage((function(e){return o.status(200).json(e)}))}catch(e){console.log(e),o.status(201).json(e)}return o.status(200).json()})),i.get("/versao",((e,o)=>{r.updateVersion((function(e,t){return e?o.status(500).json(!1):o.status(200).json(!0)}))})),i.get("/cfgall",((e,o)=>{s.executeQuerySL("SELECT C.*, GEN_ID(gen_cfgeventos_id,0)+1 as proxid FROM CFGALL C",[],(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.post("/cfgall",((e,o)=>{let t=" UPDATE CFGALL ",n=[];e.body.lastuser&&(t+=" SET LASTUSER = ? ",n.push(e.body.lastuser)),0!==e.body.automator&&1!==e.body.automator||(t+=" SET AUTOMATOR = ? ",n.push(e.body.automator)),0!==e.body.diasfixos&&1!==e.body.diasfixos||(t+=" SET DIASFIXOS = ? ",n.push(e.body.diasfixos)),e.body.maxdiasatraso&&(t+=" SET MAXDIASATRASO = ? ",n.push(e.body.maxdiasatraso)),0!==e.body.msgunica&&1!==e.body.msgunica||(t+=" SET MSGUNICA = ? ",n.push(e.body.msgunica)),0!==e.body.remoto&&1!==e.body.remoto||(t+=" SET REMOTO = ? ",n.push(e.body.remoto)),0!==e.body.boletosemitidos&&1!==e.body.boletosemitidos||(t+=" SET BOLETOSEMITIDOS = ? ",n.push(e.body.boletosemitidos)),e.body.caminhorede&&(t+=" SET CAMINHOREDE = ? ",n.push(e.body.caminhorede)),0!==e.body.multiempresa&&1!==e.body.multiempresa||(t+=" SET MULTIEMPRESA = ? ",n.push(e.body.multiempresa)),e.body.empresa&&(t+=" SET EMPRESA = ? ",n.push(e.body.empresa)),s.executeQuerySL(t,n,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.get("/statusdb",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t);if("1"===e.query.grupo&&JSON.stringify(n)!==JSON.stringify(e.query)){n=e.query;let o=JSON.stringify(n);a.writeFileSync("./config.json",o)}s.testCon((function(e,t){e?(console.log(e),o.status(500).json(e)):o.status(200).json(t)}))})),i.get("/configdb",((e,o)=>{let t=a.readFileSync("./config.json"),n=JSON.parse(t);o.status(200).json(n)})),i.post("/savecfgeventos",(async(e,o)=>{let t,n;null===e.body.cod_evento?(t="INSERT INTO CFGEVENTOS(TIPO, DESCRICAO, DIAS, MENSAGEM, CJOPERACAO, STATUS, SQL) VALUES (?,?,?,?,?,?,?)",n=[parseInt(e.body.tipo),e.body.descricao,parseInt(e.body.dias),e.body.mensagem,parseInt(e.body.cjoperacao),e.body.status,e.body.sql]):(t="UPDATE OR INSERT INTO CFGEVENTOS(COD_EVENTO, TIPO, DESCRICAO, DIAS, MENSAGEM, CJOPERACAO, STATUS, SQL) VALUES (?,?,?,?,?,?,?,?) MATCHING (COD_EVENTO)",n=[parseInt(e.body.cod_evento),parseInt(e.body.tipo),e.body.descricao,parseInt(e.body.dias),e.body.mensagem,parseInt(e.body.cjoperacao),e.body.status,e.body.sql]),s.executeQuerySL(t,n,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.post("/cfgeventos",(async(e,o)=>{let t,n;t=" UPDATE CFGEVENTOS C SET MANUAL = ? WHERE C.COD_EVENTO = ?",n=[e.body.manual,parseInt(e.body.cod_evento)],s.executeQuerySL(" UPDATE CFGEVENTOS C SET MANUAL = ? WHERE C.COD_EVENTO = ?",n,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.get("/eventos",((e,o)=>{let t,n="SELECT E.*, E.ID_CLIENTE AS IDCLIENTE, C.DESCRICAO AS EVENTO, CAST(E.MENSAGEM AS VARCHAR(5000)) AS MENSAGEM, (select c.msgunica from cfgall c) as msgunica FROM EVENTOS E JOIN CFGEVENTOS C ON C.COD_EVENTO = E.COD_EVENTO WHERE E.DATA = ? AND E.STATUS <> 'Excecao' AND E.STATUS <> 'Duplicado ' ",a=(new Date).toLocaleString("pt-BR");t=e.query.data?[e.query.data]:[a],e.query.filtro&&e.query.filtro.length>0&&(n+=" AND E.STATUS IN (",e.query.filtro.map((e=>{"true"===e.status&&(n+=`'${e.nome}', `)})),n+="'')"),n+=" ORDER BY E.STATUS,E.ID_CLIENTE,E.VENCIMENTO ",s.executeQuerySL(n,t,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.post("/eventos",(async(e,o)=>{let t,n;t="UPDATE EVENTOS SET NOME = ?, TELEFONE1 = ?, TELEFONE2 = ?, MENSAGEM = ?, DATA = ?, STATUS = ?, LOG = ?, PRIMEIRONOME = ?, IDADE = ?, VALOR = ?, VENCIMENTO = ?, NUMDOC = ?, CODIGODEBARRASBOLETO = ?, RAZAOSOCIAL = ? WHERE ID = ?",n=[e.body.nome,e.body.telefone1,e.body.telefone2,e.body.mensagem,e.body.data,e.body.status,e.body.log,e.body.primeironome,e.body.idade,e.body.valor,e.body.vencimento,e.body.numdoc,e.body.codigodebarrasboleto,e.body.razaosocial,e.body.id],s.executeQuerySL("UPDATE EVENTOS SET NOME = ?, TELEFONE1 = ?, TELEFONE2 = ?, MENSAGEM = ?, DATA = ?, STATUS = ?, LOG = ?, PRIMEIRONOME = ?, IDADE = ?, VALOR = ?, VENCIMENTO = ?, NUMDOC = ?, CODIGODEBARRASBOLETO = ?, RAZAOSOCIAL = ? WHERE ID = ?",n,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.delete("/eventos",(async(e,o)=>{let t;t=" delete from eventos e where e.cod_evento in (select c.cod_evento from cfgeventos c where c.tipo = 2) and e.data = current_date and e.status = 'Pendente' ",s.executeQuerySL(" delete from eventos e where e.cod_evento in (select c.cod_evento from cfgeventos c where c.tipo = 2) and e.data = current_date and e.status = 'Pendente' ",[],(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.patch("/atualizaeventos",(function(e,o){let t=[e.body.mensagem,e.body.status,e.body.log,parseInt(e.body.id)];s.executeQuerySL("UPDATE EVENTOS SET MENSAGEM = ?, STATUS = ?, LOG = ? WHERE ID = ?",t,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json({result:t})}))})),i.post("/enviaeventos",(function(e,o){lista=[],e.body.length>0?lista=e.body:o.status(204).json("Lista vazia"),c.enviaEventos(lista,(function(e,t){e?o.status(204).json(e):o.status(200).json(t)}))})),i.post("/enviapromocao",(function(e,o){c.enviaPromocao(e.body,(function(e,t){e?o.status(204).json(e):o.status(200).json(t)}))})),i.get("/allcfgeventos",((e,o)=>{let t=[parseInt(e.body.cod_evento),e.body.descricao,e.body.status,e.body.mensagem];s.executeQuerySL("SELECT C.*, CAST(C.MENSAGEM AS VARCHAR(5000)) AS MENSAGEM FROM CFGEVENTOS C ORDER BY C.COD_EVENTO",t,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.get("/cfgeventos1",((e,o)=>{let t=[parseInt(e.body.cod_evento),e.body.descricao,e.body.status,e.body.mensagem];s.executeQuerySL("SELECT C.*, CAST(C.MENSAGEM AS VARCHAR(5000)) AS MENSAGEM FROM CFGEVENTOS C WHERE C.TIPO = 1 ORDER BY C.COD_EVENTO",t,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.get("/cfgeventos2",((e,o)=>{let t=[parseInt(e.body.cod_evento),e.body.descricao,e.body.status,e.body.mensagem];s.executeQuerySL("SELECT C.*, CAST(C.MENSAGEM AS VARCHAR(5000)) AS MENSAGEM FROM CFGEVENTOS C WHERE C.TIPO = 2 ORDER BY C.DIAS",t,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.get("/cfgeventos3",((e,o)=>{let t=[parseInt(e.body.cod_evento),e.body.descricao,e.body.status,e.body.mensagem];s.executeQuerySL("SELECT C.*, CAST(C.MENSAGEM AS VARCHAR(5000)) AS MENSAGEM, CAST(C.SQL AS VARCHAR(2000)) AS SQL FROM CFGEVENTOS C WHERE C.TIPO = 3 ORDER BY C.COD_EVENTO",t,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.get("/cfgeventos4",((e,o)=>{let t=[parseInt(e.body.cod_evento),e.body.descricao,e.body.status,e.body.mensagem];s.executeQuerySL("SELECT C.*, CAST(C.MENSAGEM AS VARCHAR(5000)) AS MENSAGEM, CAST(C.SQL AS VARCHAR(2000)) AS SQL FROM CFGEVENTOS C WHERE C.TIPO = 4 ORDER BY C.COD_EVENTO",t,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.delete("/cfgeventos",((e,o)=>{let t=[parseInt(e.query.cod_evento)];s.executeQuerySL("DELETE FROM CFGEVENTOS WHERE COD_EVENTO = ?",t,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.get("/carregaeventos",(async(e,o)=>{c.carregaEventos().then((e=>o.status(200).json(e)))})),i.get("/vendedoreserp",((e,o)=>{s.executeQueryERP(" SELECT V.VENDEDOR, cast(v.nome as varchar(100) character set ISO8859_1) AS NOME FROM VENDEDOR V where tipo = 0 and INATIVO = 'N' ORDER BY V.NOME ",[],(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.get("/categoriaserp",((e,o)=>{s.executeQueryERP(" select CATEGORIA,cast(nome as varchar(100) character set ISO8859_1) AS NOME from categoria ",[],(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.get("/situacoeserp",((e,o)=>{s.executeQueryERP(" SELECT situacao, cast(nome as varchar(100) character set ISO8859_1) AS NOME FROM SITUACAO WHERE TIPO=0 ",[],(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.get("/clienteserp",((e,o)=>{let t="\n    SELECT DISTINCT C.CLIENTE, C.CLIENTE as ID_CLIENTE, cast(c.nome as varchar(100) character set ISO8859_1) AS NOME, cast(c.nome as varchar(100) character set ISO8859_1) AS NOMECLIENTE,CC.RAZAO as RAZAOSOCIAL,CE.TELEFONE as TELEFONE1, (select first(1) ce1.telefone from cli_ende ce1 where ce1.cliente = c.cliente and ce1.tipo = 'T')as telefone2, CID.NOME AS CIDADE, cast(B.NOME as varchar(100) character set ISO8859_1) AS BAIRRO,(select cat.nome from categoria cat where cat.categoria=C.categoria) as Categoria,C.CONVENIO,C.SITUACAO,C.VENDEDOR,'Pendente' as status\n     FROM CLIENTE C\n     LEFT JOIN SITUACAO S ON C.SITUACAO = S.SITUACAO \n     LEFT JOIN CONVENIO CV ON C.CONVENIO = CV.CONVENIO \n     LEFT JOIN CLI_ENDE CE ON C.CLIENTE = CE.CLIENTE AND CE.TIPO = 'R'\n     LEFT JOIN CLI_COMP CC ON CC.CLIENTE = C.CLIENTE\n     LEFT JOIN BAIRRO B ON CE.BAIRRO = B.BAIRRO\n     LEFT JOIN CIDADE CID ON CE.CIDADE = CID.CIDADE\n     WHERE C.CLIENTE IS NOT NULL\n     AND (c.flg_inativo is null or c.flg_inativo = '0')\n    ",n=[];e.query.vendedor&&(t+=" AND C.VENDEDOR = ? ",n.push(parseFloat(e.query.vendedor))),e.query.categoria&&(t+=" AND C.CATEGORIA = ? ",n.push(e.query.categoria)),e.query.situacao&&(t+=" AND C.SITUACAO = ? ",n.push(e.query.situacao)),e.query.personalizado&&"1"===e.query.personalizado&&(t+=" AND C.CLIENTE IN (select distinct v.cliente from venda v where v.datdoc >= CURRENT_DATE - 90) "),s.executeQueryERP(t,n,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.get("/centrocustoerp",((e,o)=>{s.executeQueryERP("\n    Select CENTCUSTO.CCUSTO as ID_CC, CENTCUSTO.CCUSTO as IDCC, cast(CENTCUSTO.NOME as varchar(100) character set ISO8859_1) AS NOME  FROM CENTCUSTO WHERE TIPO=0\n    ",[],(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.get("/eventosexcecao",((e,o)=>{let t=[e.query.cod_evento];s.executeQuerySL(" SELECT * FROM EVENTOS_EXCECAO WHERE COD_EVENTO = ?",t,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.post("/eventosexcecao",((e,o)=>{let t=[e.body.cod_evento,e.body.id_cliente];s.executeQuerySL("UPDATE OR INSERT INTO EVENTOS_EXCECAO(COD_EVENTO, ID_CLIENTE) VALUES (?,?) MATCHING (COD_EVENTO, ID_CLIENTE)",t,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.delete("/eventosExcecao",((e,o)=>{let t=[e.query.cod_evento,e.query.id_cliente];s.executeQuerySL("DELETE FROM EVENTOS_EXCECAO WHERE COD_EVENTO = ? AND ID_CLIENTE = ?",t,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.get("/centrocustoexcecao",((e,o)=>{let t=[e.query.cod_evento];s.executeQuerySL(" SELECT * FROM EVENTOS_EXCECAO_CC WHERE COD_EVENTO = ?",t,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.post("/centrocustoexcecao",((e,o)=>{let t=[e.body.cod_evento,e.body.id_cc];s.executeQuerySL("UPDATE OR INSERT INTO EVENTOS_EXCECAO_CC(COD_EVENTO, ID_CC) VALUES (?,?) MATCHING (COD_EVENTO, ID_CC)",t,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.delete("/centrocustoexcecao",((e,o)=>{let t=[e.query.cod_evento,e.query.id_cc];s.executeQuerySL("DELETE FROM EVENTOS_EXCECAO_CC WHERE COD_EVENTO = ? AND ID_CC = ?",t,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.get("/promocaoerp",((e,o)=>{s.executeQueryERP("SELECT T.COD_PROMOCAO, cast(T.NOM_PROMOCAO as varchar(100) character set ISO8859_1) AS NOM_PROMOCAO FROM TAB_PROMOCAO T WHERE T.dat_final >= CURRENT_DATE",[],(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.get("/promocaoapi",((e,o)=>{let t=[parseFloat(e.query.id_promocao)];s.executeQuerySL("SELECT P.*, CAST(MENSAGEM AS VARCHAR(5000)) AS MENSAGEM, CAST(LEGENDA AS VARCHAR(1000)) AS LEGENDA FROM PROMOCAO P WHERE P.ID_PROMOCAO = ?",t,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.get("/promocaologs",((e,o)=>{let t=[e.query.id_promocao];s.executeQuerySL(" SELECT * FROM PROMOCAO_LOGS P WHERE P.ID_PROMOCAO = ? ORDER BY DATA DESC",t,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.post("/promocaologs",((e,o)=>{let t=[e.body.data,e.body.id_promocao,e.body.id_cliente,e.body.status];s.executeQuerySL(" UPDATE OR INSERT INTO PROMOCAO_LOGS(DATA,ID_PROMOCAO,ID_CLIENTE,STATUS) VALUES (?,?,?,?) MATCHING (DATA,ID_PROMOCAO,ID_CLIENTE,STATUS) ",t,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.post("/promocaoapi",((e,o)=>{if(e.body.pause){const t="DELETE FROM PROMOCAO_LOGS WHERE ID_PROMOCAO = ? AND STATUS = 'Pendente'",n=[e.body.id_promocao];s.executeQuerySL(t,n,(function(e,t){if(e)return console.log(e),void o.status(500).send(e+"")}))}let t=[e.body.id_promocao,e.body.mensagem,e.body.legenda,e.body.maximodiario,e.body.status];s.executeQuerySL("UPDATE OR INSERT INTO PROMOCAO(ID_PROMOCAO,MENSAGEM, LEGENDA, MAXIMODIARIO, STATUS) VALUES (?,?,?,?,?) MATCHING (ID_PROMOCAO)",t,(function(e,t){if(e)return o.status(500).send(e+""),void console.log(e);o.status(200).json(t)}))}));const O=(e,o,t)=>{const n=function(e,o){const t=[];for(let n=0;n<e.length;n+=o){const a=e.slice(n,n+o);t.push(a)}return t}(e,o);for(let e=0;e<n.length;e++)for(let o=0;o<n[e].length;o++){const a=n[e][o];n[e][o]=t(a)}return n};i.post("/agendapromocao",(async(e,o)=>{const t=e.body.produtos,n=e.body.clientes,a=O(t,100,(o=>[e.body.id_promocao,o.codigoproduto,o.nomeproduto,o.valororiginal,o.valorpromocional,o.percentualdesconto,o.base64])),E=O(n,100,(o=>[e.body.id_promocao,o.cliente,o.status||"Pendente",o.nome,o.telefone1,o.telefone2])),c=[e.body.id_promocao];try{const e=new Promise(((e,o)=>{s.executeQuerySL("UPDATE PROMOCAO SET STATUS = 2 WHERE ID_PROMOCAO = ?",c,(function(t,n){t?o(t):e(n)}))})),t=s.executeBatchInsertSL("UPDATE OR INSERT INTO PROMOCAO_PRODUTOS(ID_PROMOCAO, ID_PRODUTO, NOMEPRODUTO, VALORORIGINAL, VALORPROMOCIONAL, PERCENTUALDESCONTO, BASE64) VALUES (?,?,?,?,?,?,?) MATCHING (ID_PROMOCAO, ID_PRODUTO)",a),n=s.executeBatchInsertSL("UPDATE OR INSERT INTO PROMOCAO_LOGS(ID_PROMOCAO, ID_CLIENTE, STATUS, NOME, TELEFONE1, TELEFONE2) VALUES (?,?,?,?,?,?) MATCHING (ID_PROMOCAO, ID_CLIENTE)",E);await Promise.all([e,t,n]),o.status(200).json(!0)}catch(e){console.error("Erro durante a inserção de lotes:",e),o.status(500).json(!1)}})),i.post("/enviatestepromocao",(async(e,o)=>{const t=e.body;await c.testaEnviaPromocao(t)?o.status(200).json(!0):o.status(200).json(!1)})),i.post("/reabrirpromocao",(async(e,o)=>{const t=e.body;if(t.historico){const n="DELETE FROM PROMOCAO_LOGS WHERE ID_PROMOCAO = ? AND STATUS <> 'Enviado'",a=[e.body.id_promocao];s.executeQuerySL(n,a,(function(e,t){if(e)return console.log(e),void o.status(500).send(e+"")}));let E="UPDATE PROMOCAO SET STATUS = 1 WHERE ID_PROMOCAO = ?",c=[t.id_promocao];s.executeQuerySL(E,c,(function(e,t){if(e)return o.status(500).send(e+""),void console.log(e);o.status(200).json(t)}))}if(!t.historico){const n="DELETE FROM PROMOCAO_LOGS WHERE ID_PROMOCAO = ?",a=[e.body.id_promocao];s.executeQuerySL(n,a,(function(e,t){if(e)return console.log(e),void o.status(500).send(e+"")}));let E="UPDATE PROMOCAO SET STATUS = 1 WHERE ID_PROMOCAO = ?",c=[t.id_promocao];s.executeQuerySL(E,c,(function(e,t){if(e)return o.status(500).send(e+""),void console.log(e);o.status(200).json(t)}))}})),i.get("/produtospromocaoerp",((e,o)=>{let t=[e.query.cod_promocao];s.executeQueryERP("\n    SELECT \n        P.produto as codigoproduto\n        , cast(P.nome as varchar(100) character set ISO8859_1) AS nomeproduto \n        , E.vrvend as valororiginal \n        , T.vlr_vend_promocao as valorpromocional \n        , T.num_per_promocao as percentualdesconto \n        , PF.foto as nomefoto\n        , PF.base64\n    FROM TAB_PROMOCAO_ITEM T \n    JOIN PRODUTO P ON P.produto = T.cod_produto \n    JOIN ESTOQUE E ON E.deposito = T.cod_deposito AND E.produto = P.produto \n    JOIN PRODUTOFOTO PF ON PF.produto = P.produto\n    WHERE T.cod_promocao = ?\n    AND PF.ID = (\n        SELECT FIRST 1 PF2.ID\n        FROM PRODUTOFOTO PF2\n        WHERE PF2.produto = P.produto\n        ORDER BY 1\n    )\n    ",t,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.get("/mapa",((e,o)=>{s.executeQueryERP("SELECT * FROM MAPA ORDER BY MAPA DESC",[],(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))})),i.get("/mapavendas",((e,o)=>{let t=[e.query.mapa];s.executeQueryERP(" SELECT V.VENDA,  V.MAPA,  V.CLIENTE,  C.NOME,  V.NRODOC,  V.DATDOC,  VDD.NOME AS VENDEDOR,  V.TOTALDOC,  CE.endereco || ' ' || CE.nro || ' ' || B.NOME || ' ' || CD.NOME || ',' || CD.UF  as ENDERECO  FROM VENDA V  LEFT JOIN CLIENTE C ON V.CLIENTE = C.CLIENTE  LEFT JOIN CLI_ENDE CE ON V.CLIENTE = CE.CLIENTE AND CE.TIPO = 'R'  LEFT JOIN BAIRRO B ON B.BAIRRO = CE.BAIRRO  LEFT JOIN CIDADE CD ON CE.CIDADE = CD.CIDADE  LEFT JOIN VENDEDOR VDD ON VDD.VENDEDOR = V.VENDEDOR  WHERE V.MAPA = ?  AND V.CANCELADO IS NULL  ORDER BY V.NRODOC, V.CLIENTE, V.DATDOC ",t,(function(e,t){e?(o.status(500).send(e+""),console.log(e)):o.status(200).json(t)}))}));let l=a.readFileSync("./config.json"),T=JSON.parse(l);i.listen(T.portApi,(()=>{console.log(">>> WebApi started <<<")}))})()})();